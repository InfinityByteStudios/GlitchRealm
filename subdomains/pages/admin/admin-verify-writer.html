<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Verify Writer - GlitchRealm</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #0a0a0a;
      color: #fff;
      padding: 40px 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(20,20,30,0.9);
      border: 1px solid rgba(0,255,249,0.3);
      border-radius: 12px;
      padding: 30px;
    }
    h1 {
      color: #00fff9;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    .field {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #00fff9;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 12px;
      background: rgba(10,10,20,0.8);
      border: 1px solid rgba(0,255,249,0.3);
      border-radius: 6px;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
    }
    button {
      background: linear-gradient(90deg, #00fff9, #008cff);
      border: none;
      border-radius: 30px;
      padding: 14px 28px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #02141c;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,255,249,0.4);
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    .status.success {
      background: rgba(0,255,65,0.1);
      border: 1px solid rgba(0,255,65,0.3);
      color: #00ff41;
    }
    .status.error {
      background: rgba(255,80,80,0.1);
      border: 1px solid rgba(255,80,80,0.3);
      color: #ff9393;
    }
    .info {
      background: rgba(0,255,249,0.1);
      border: 1px solid rgba(0,255,249,0.3);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    .current-user {
      background: rgba(255,165,0,0.1);
      border: 1px solid rgba(255,165,0,0.3);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Admin: Verify Writer</h1>
    
    <div class="info">
      <strong>‚ö†Ô∏è Admin Only</strong><br>
      This tool creates or updates <code>verified_writers</code> documents. Only developers can use this.
    </div>

    <div id="auth-status" class="current-user" style="display:none;">
      <strong>Signed in as:</strong> <span id="current-user-email"></span><br>
      <strong>UID:</strong> <span id="current-user-uid"></span>
    </div>

    <div class="field">
      <label>User ID to Verify</label>
      <input type="text" id="uid-input" placeholder="Paste user UID here">
      <small style="opacity:0.7; font-size:0.85rem;">Get this from Firebase Console ‚Üí Authentication</small>
    </div>

    <div class="field">
      <label>Verified Status</label>
      <select id="verified-status">
        <option value="true">‚úÖ Verified (can publish articles)</option>
        <option value="false">‚ùå Not Verified (revoke access)</option>
      </select>
    </div>

    <div class="field">
      <label>Badge Type (optional)</label>
      <select id="badge-type">
        <option value="">None</option>
        <option value="writer">Writer</option>
        <option value="creator">Creator</option>
        <option value="developer">Developer</option>
        <option value="community">Community</option>
      </select>
    </div>

    <button id="verify-btn">Apply Verification Status</button>
    <button id="check-btn" style="background:linear-gradient(90deg,#444,#666);">Check Current Status</button>

    <div id="status-msg" class="status"></div>
  </div>

  <script type="module">
    import { getFirestore, doc, setDoc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const db = getFirestore(window.firebaseApp);
    const auth = getAuth(window.firebaseApp);

    const DEV_UIDS = [
      '6iZDTXC78aVwX22qrY43BOxDRLt1',
      'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
      'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
      '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
      'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
    ];

    function isDev(uid) {
      return DEV_UIDS.includes(uid);
    }

    function redirectToAuth() {
      const currentUrl = window.location.href;
      const returnUrl = encodeURIComponent(currentUrl);
      
      try {
        localStorage.setItem('gr.returnTo', currentUrl);
      } catch (e) {}
      
      window.location.href = `https://auth.glitchrealm.ca/#return=${returnUrl}`;
    }

    function showStatus(message, isError = false) {
      const statusEl = document.getElementById('status-msg');
      statusEl.textContent = message;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 8000);
    }

    document.getElementById('verify-btn').addEventListener('click', async () => {
      try {
        const user = auth.currentUser;
        if (!user || !isDev(user.uid)) {
          showStatus('‚õî Access denied. Developers only.', true);
          return;
        }

        const targetUid = document.getElementById('uid-input').value.trim();
        if (!targetUid) {
          showStatus('‚ö†Ô∏è Please enter a user UID', true);
          return;
        }

        const verified = document.getElementById('verified-status').value === 'true';
        const badgeType = document.getElementById('badge-type').value || null;

        const writerData = {
          verified: verified,
          verifiedAt: Timestamp.now(),
          reviewerId: user.uid,
          ...(badgeType && { badgeType })
        };

        await setDoc(doc(db, 'verified_writers', targetUid), writerData);

        showStatus(
          `‚úÖ User ${targetUid} ${verified ? 'verified' : 'unverified'} successfully!${badgeType ? ` Badge: ${badgeType}` : ''}`,
          false
        );

        // Clear input
        document.getElementById('uid-input').value = '';
      } catch (err) {
        console.error('Verification error:', err);
        showStatus('‚ùå Error: ' + err.message, true);
      }
    });

    document.getElementById('check-btn').addEventListener('click', async () => {
      try {
        const user = auth.currentUser;
        if (!user || !isDev(user.uid)) {
          showStatus('‚õî Access denied. Developers only.', true);
          return;
        }

        const targetUid = document.getElementById('uid-input').value.trim();
        if (!targetUid) {
          showStatus('‚ö†Ô∏è Please enter a user UID', true);
          return;
        }

        const writerDoc = await getDoc(doc(db, 'verified_writers', targetUid));
        
        if (!writerDoc.exists()) {
          showStatus(`‚ÑπÔ∏è User ${targetUid} has no verified_writers document (not verified)`, false);
        } else {
          const data = writerDoc.data();
          showStatus(
            `üìã Status: ${data.verified ? '‚úÖ Verified' : '‚ùå Not Verified'}\n` +
            `Badge: ${data.badgeType || 'None'}\n` +
            `Verified at: ${data.verifiedAt?.toDate?.() || 'Unknown'}\n` +
            `Reviewer: ${data.reviewerId || 'Unknown'}`,
            false
          );
        }
      } catch (err) {
        console.error('Check error:', err);
        showStatus('‚ùå Error: ' + err.message, true);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('auth-status').style.display = 'block';
        document.getElementById('current-user-email').textContent = user.email || 'No email';
        document.getElementById('current-user-uid').textContent = user.uid;

        if (!isDev(user.uid)) {
          document.querySelector('.container').innerHTML = `
            <h1>üîê Access Denied</h1>
            <div class="info">
              <strong>‚õî Developer Access Required</strong><br>
              This tool is restricted to developers only.
            </div>
          `;
        }
      } else {
        document.querySelector('.container').innerHTML = `
          <h1>üîê Sign In Required</h1>
          <div class="info">
            <strong>‚ö†Ô∏è Not Signed In</strong><br>
            You must be signed in as a developer to use this tool.
          </div>
          <button onclick="window.redirectToAuth?.()" style="display:inline-block; margin-top:20px; background:linear-gradient(90deg,#00fff9,#008cff); border:none; border-radius:30px; padding:14px 28px; font-size:.9rem; font-weight:700; color:#02141c; cursor:pointer;">Sign In</button>
        `;
        
        window.redirectToAuth = redirectToAuth;
      }
    });
  </script>
  <script src="js/firebase-core.js"></script>
</body>
</html>
