<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Your Game - GlitchRealm</title>
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" href="/assets/Favicon and Icons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/assets/Favicon and Icons/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/Favicon and Icons/apple-touch-icon.png" />
  <link rel="preload" as="style" href="styles.css" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="styles.css"></noscript>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//www.gstatic.com">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
  </noscript>
  <style>
    .submit-wrapper { max-width: 960px; margin: 120px auto 60px; padding: 0 20px; }
    .submit-header { text-align: center; margin-bottom: 32px; }
    .submit-header h1 { font-family: 'Orbitron', monospace; letter-spacing: 1px; font-size: 2.1rem; margin: 0 0 12px; }
    .submit-header p { opacity:.8; line-height:1.5; }
    .game-submit-card { background: linear-gradient(145deg, rgba(0,10,20,.85), rgba(0,40,55,.55)); border:1px solid rgba(0,255,249,.15); backdrop-filter: blur(10px); padding:32px 28px 36px; border-radius:18px; box-shadow:0 4px 22px -4px rgba(0,0,0,.55), 0 0 0 1px rgba(0,255,249,.05) inset; position:relative; }
    .game-submit-card:before { content:""; position:absolute; inset:0; pointer-events:none; border-radius:18px; background: radial-gradient(circle at 30% 20%, rgba(0,255,249,.12), transparent 70%), radial-gradient(circle at 85% 65%, rgba(0,140,255,.15), transparent 75%); mix-blend-mode:screen; opacity:.8; }
    form#submitGameForm { display:flex; flex-direction:column; gap:22px; }
    .input-container { position:relative; }
    .input-label { font-size:.75rem; letter-spacing:1px; text-transform:uppercase; opacity:.75; font-weight:600; margin-bottom:6px; font-family:'Orbitron', monospace; }
    .neural-input, .neural-input[type=file], textarea.neural-input { width:100%; background:rgba(0,8,12,.5); border:1px solid rgba(0,255,249,.25); border-radius:10px; padding:12px 14px; color:#fff; font-family:'Rajdhani', sans-serif; font-size:.95rem; box-shadow:0 0 0 0 rgba(0,255,249,.35) inset, 0 0 0 1px rgba(0,255,249,.08); transition:.25s; }
    .neural-input:focus { outline:none; border-color:var(--primary-cyan,#0ff); box-shadow:0 0 0 2px rgba(0,255,249,.25); }
    textarea.neural-input { resize:vertical; min-height:140px; }
    .tag-row { display:flex; gap:10px; }
    .tag-row input { flex:1; }
    #submissionCoverPreviewWrap { margin-top:8px; display:none; }
    #submissionCoverPreview { max-width:100%; max-height:220px; border-radius:14px; box-shadow:0 0 22px -4px rgba(0,255,249,.4); border:1px solid rgba(0,255,249,.25); }
    .submit-actions { display:flex; gap:14px; justify-content:flex-end; margin-top:10px; }
    .btn { font-family:'Orbitron', monospace; letter-spacing:.75px; font-size:.7rem; padding:12px 22px; border-radius:10px; cursor:pointer; border:1px solid var(--primary-cyan,#0ff); background:linear-gradient(135deg, rgba(0,255,249,.15), rgba(0,140,255,.15)); color:#fff; text-transform:uppercase; font-weight:700; transition:.25s; }
    .btn:hover:not([disabled]) { background:linear-gradient(135deg, rgba(0,255,249,.25), rgba(0,140,255,.25)); box-shadow:0 0 12px -2px rgba(0,255,249,.4); }
    .btn[disabled] { opacity:.55; cursor:not-allowed; }
    .btn-secondary { background:rgba(255,255,255,.07); border-color:rgba(0,255,249,.35); }
    .info-message, .success-message, .error-message { font-size:.8rem; padding:10px 14px; border-radius:8px; line-height:1.4; }
    .info-message { background:rgba(0,140,255,.16); border:1px solid rgba(0,140,255,.4); }
    .success-message { background:rgba(0,255,170,.16); border:1px solid rgba(0,255,170,.4); }
    .error-message { background:rgba(255,40,60,.16); border:1px solid rgba(255,40,60,.4); }
    .warning-message { background:rgba(255,165,0,.1); border:1px solid rgba(255,165,0,.5); padding:12px 14px; font-size:.8rem; border-radius:10px; margin-bottom:12px; }
    .pre-badge { display:none; background:linear-gradient(135deg, rgba(255,165,0,.95), rgba(255,99,71,.95)); color:#0b0e14; font-family:'Orbitron', monospace; font-weight:800; letter-spacing:.4px; font-size:9px; padding:2px 6px; border-radius:5px; text-transform:uppercase; box-shadow:0 1px 4px rgba(255,140,0,.25); border:1px solid rgba(0,0,0,.12); user-select:none; white-space:nowrap; }
    .gate-block { margin:0 0 18px; }
    .auth-redirect { text-align:center; margin-top:24px; font-size:.85rem; opacity:.75; }
    @media (max-width:680px){ .submit-wrapper { margin-top:100px; } }
  /* Requirements step styles */
  .requirements-card { background: linear-gradient(145deg, rgba(0,10,20,.85), rgba(0,40,55,.55)); border:1px solid rgba(0,255,249,.15); backdrop-filter: blur(10px); padding:32px 28px 36px; border-radius:18px; box-shadow:0 4px 22px -4px rgba(0,0,0,.55), 0 0 0 1px rgba(0,255,249,.05) inset; position:relative; }
  .requirements-card:before { content:""; position:absolute; inset:0; pointer-events:none; border-radius:18px; background: radial-gradient(circle at 30% 20%, rgba(0,255,249,.12), transparent 70%), radial-gradient(circle at 85% 65%, rgba(0,140,255,.15), transparent 75%); mix-blend-mode:screen; opacity:.8; }
  .requirements-card h2 { font-family: 'Orbitron', monospace; font-size: 1.5rem; margin: 0 0 20px; letter-spacing: 1px; color: var(--primary-cyan, #0ff); text-align: center; }
  .requirements-section { margin-bottom: 28px; }
  .requirements-section h3 { font-family: 'Orbitron', monospace; font-size: 1.1rem; margin: 0 0 12px; letter-spacing: 0.5px; color: rgba(0,255,249,.85); }
  .requirements-list { list-style: none; padding: 0; margin: 0 0 0 8px; }
  .requirements-list li { position: relative; padding-left: 24px; margin-bottom: 10px; line-height: 1.6; }
  .requirements-list li:before { content: ""; position: absolute; left: 0; top: 8px; width: 8px; height: 8px; background: var(--primary-cyan, #0ff); border-radius: 50%; box-shadow: 0 0 8px rgba(0,255,249,.6); }
  .guidelines-box { background: rgba(0,140,255,.08); border: 1px solid rgba(0,140,255,.3); border-radius: 10px; padding: 16px 18px; margin-top: 18px; }
  .guidelines-box p { margin: 8px 0; line-height: 1.5; font-size: 0.9rem; }
  .acceptance-box { background: rgba(255,165,0,.08); border: 1px solid rgba(255,165,0,.4); border-radius: 10px; padding: 16px 18px; margin-top: 20px; display: flex; align-items: center; gap: 12px; }
  .acceptance-box input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-cyan, #0ff); }
  .acceptance-box label { cursor: pointer; user-select: none; flex: 1; line-height: 1.4; }
  .next-btn-container { display: flex; justify-content: center; margin-top: 24px; }
  .btn-next { font-family:'Orbitron', monospace; letter-spacing:.75px; font-size:.85rem; padding:14px 32px; border-radius:10px; cursor:pointer; border:1px solid var(--primary-cyan,#0ff); background:linear-gradient(135deg, rgba(0,255,249,.2), rgba(0,140,255,.2)); color:#fff; text-transform:uppercase; font-weight:700; transition:.25s; }
  .btn-next:hover:not([disabled]) { background:linear-gradient(135deg, rgba(0,255,249,.35), rgba(0,140,255,.35)); box-shadow:0 0 16px -2px rgba(0,255,249,.5); transform: translateY(-2px); }
  .btn-next[disabled] { opacity:.4; cursor:not-allowed; }
  .back-to-requirements { text-align: center; margin-bottom: 20px; }
  .btn-back { font-family:'Rajdhani', sans-serif; font-size:.85rem; padding:8px 18px; border-radius:8px; cursor:pointer; border:1px solid rgba(0,255,249,.3); background:rgba(0,255,249,.05); color:rgba(0,255,249,.85); text-transform:none; font-weight:600; transition:.25s; display:inline-flex; align-items:center; gap:6px; }
  .btn-back:hover { background:rgba(0,255,249,.12); border-color:rgba(0,255,249,.5); color:#0ff; }
  .btn-back:before { content:"←"; font-size:1.2rem; }
  /* Step Indicator Styles */
  .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 40px; gap: 12px; }
  .step { display: flex; align-items: center; gap: 12px; }
  .step-number { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(0,255,249,.3); background: rgba(0,10,20,.6); display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', monospace; font-weight: 700; font-size: 1.1rem; color: rgba(0,255,249,.5); transition: all 0.3s ease; }
  .step-number.active { border-color: var(--primary-cyan, #0ff); background: rgba(0,255,249,.15); color: var(--primary-cyan, #0ff); box-shadow: 0 0 16px rgba(0,255,249,.4); }
  .step-number.completed { border-color: rgba(0,255,170,.8); background: rgba(0,255,170,.15); color: rgba(0,255,170,.9); }
  .step-number.clickable-step { cursor: pointer; user-select: none; }
  /* Hover effect for completed steps - green glow */
  .step-number.clickable-step.completed:hover { border-color: rgba(0,255,170,1); background: rgba(0,255,170,.25); transform: scale(1.1); box-shadow: 0 0 20px rgba(0,255,170,.6); }
  /* Hover effect for active step - cyan glow */
  .step-number.clickable-step.active:hover { border-color: var(--primary-cyan, #0ff); background: rgba(0,255,249,.25); box-shadow: 0 0 20px rgba(0,255,249,.8); }
  /* Hover effect for clickable but not yet visited steps - subtle cyan (not green) */
  .step-number.clickable-step:not(.completed):not(.active):hover { border-color: rgba(0,255,249,.6); background: rgba(0,255,249,.1); transform: scale(1.05); box-shadow: 0 0 12px rgba(0,255,249,.3); }
  .step-line { width: 60px; height: 2px; background: rgba(0,255,249,.2); position: relative; }
  .step-line.completed { background: rgba(0,255,170,.6); }
  .step-label { font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; margin-top: 8px; text-align: center; opacity: 0.6; }
  .step-label.active { opacity: 1; color: var(--primary-cyan, #0ff); font-weight: 600; }
  /* Step tooltip for validation messages */
  .step-tooltip { 
    text-align: center; 
    color: var(--danger, #ff073a); 
    background: rgba(255, 7, 58, 0.1); 
    border: 1px solid var(--danger, #ff073a); 
    border-radius: 6px; 
    padding: 8px 16px; 
    font-size: 0.85rem; 
    font-family: 'Rajdhani', sans-serif;
    margin-top: -30px;
    margin-bottom: 20px;
    animation: tooltipFadeIn 0.3s ease;
    box-shadow: 0 0 10px rgba(255, 7, 58, 0.3);
  }
  @keyframes tooltipFadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @media (max-width: 600px) {
    .step-indicator { gap: 8px; }
    .step-number { width: 32px; height: 32px; font-size: 0.9rem; }
    .step-line { width: 40px; }
    .step-label { font-size: 0.75rem; }
    .step-tooltip { font-size: 0.8rem; padding: 6px 12px; }
  }
  /* Cover preview styles */
  #submissionCoverPreviewWrap { display:none; margin-top:10px; width:100%; max-width:680px; aspect-ratio:16/9; border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden; background:#0a0d14; box-shadow:0 2px 10px rgba(0,0,0,.35); }
  #submissionCoverPreview { width:100%; height:100%; object-fit:cover; display:block; background:#000; }
  
  /* Success Page Styles */
  .success-card {
    background: linear-gradient(145deg, rgba(0,25,15,.95), rgba(0,40,25,.8));
    border: 2px solid rgba(0,255,100,.3);
    border-radius: 20px;
    padding: 48px 40px;
    text-align: center;
    backdrop-filter: blur(15px);
    box-shadow: 0 12px 40px rgba(0,0,0,.6);
    margin: 0 auto;
    max-width: 600px;
  }
  .success-content {
    position: relative;
  }
  .success-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #00ff41, #00cc33);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: bold;
    color: #0a0a0a;
    margin: 0 auto 24px;
    animation: successPulse 2s ease-in-out infinite;
  }
  @keyframes successPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(0,255,65,.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0,255,65,.6); }
  }
  .success-title {
    font-family: 'Orbitron', monospace;
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 16px;
    background: linear-gradient(135deg, #00ff41, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .success-message {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 32px;
    line-height: 1.6;
  }
  .success-details {
    text-align: left;
    margin-bottom: 32px;
  }
  .success-info h3 {
    font-family: 'Orbitron', monospace;
    font-size: 1.3rem;
    color: rgba(0,255,100,.9);
    margin: 0 0 16px;
  }
  .success-info ul {
    list-style: none;
    padding: 0;
  }
  .success-info li {
    padding: 8px 0;
    padding-left: 24px;
    position: relative;
    opacity: 0.85;
  }
  .success-info li::before {
    content: '→';
    position: absolute;
    left: 0;
    color: rgba(0,255,100,.8);
    font-weight: bold;
  }
  .success-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 24px;
  }
  .btn-outline {
    background: transparent;
    border: 2px solid rgba(0,255,249,.5);
    color: rgba(0,255,249,.9);
  }
  .btn-outline:hover {
    background: rgba(0,255,249,.1);
    border-color: rgba(0,255,249,.7);
  }
  @media (max-width: 600px) {
    .success-card {
      padding: 32px 24px;
      margin: 0 16px;
    }
    .success-title {
      font-size: 1.75rem;
    }
    .success-actions {
      flex-direction: column;
    }
    .success-actions .btn {
      width: 100%;
    }
  }
  </style>
  <!-- Unified Firebase core (loads app+auth once, sets local persistence) -->
  <script type="module" src="firebase-core.js"></script>
  <!-- Firebase SDK (page-specific usage; reuses shared app/auth if present) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    // (Analytics optional; omitted to keep this page lighter.)
    const firebaseConfig = {
      apiKey: "AIzaSyCo5hr7ULHLL_0UAAst74g8ePZxkB7OHFQ",
      authDomain: "shared-sign-in.firebaseapp.com",
      projectId: "shared-sign-in",
      storageBucket: "shared-sign-in.appspot.com",
      messagingSenderId: "332039027753",
      appId: "1:332039027753:web:aa7c6877d543bb90363038",
      measurementId: "G-KK5XVVLMVN"
    };
    // Use global Firebase instance or fallback to local
    const app = window.firebaseApp || initializeApp(firebaseConfig);
    const auth = window.firebaseAuth || getAuth(app);
    const storage = window.firebaseStorage || getStorage(app, 'gs://shared-sign-in.appspot.com');
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseStorage = storage;
  </script>
</head>
<body>
  <div class="background-animation"></div>
  <div id="header-placeholder"></div>
  <div class="submit-wrapper">
    <div class="submit-header">
      <h1 id="pageMainTitle">Submit Your Game</h1>
      <p id="pageSubtitle">Share your creation with the GlitchRealm community. Verified creators and approved developers can submit games for review. Drafts start in <strong>draft</strong> status until published by staff.</p>
    </div>
    
    <!-- Step Indicator -->
    <div id="stepIndicator" class="step-indicator" style="display:none;">
      <div class="step">
        <div class="step-number clickable-step" id="step1" data-step="1">1</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="step">
        <div class="step-number clickable-step" id="step2" data-step="2">2</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="step">
        <div class="step-number clickable-step" id="step3" data-step="3">3</div>
      </div>
      <div class="step-line" id="line3"></div>
      <div class="step">
        <div class="step-number" id="step4" data-step="4">4</div>
      </div>
    </div>
    
    <!-- Tooltip for step validation messages -->
    <div id="stepTooltip" class="step-tooltip" style="display:none;"></div>
    
    <div id="gateNotice" class="warning-message gate-block" style="display:none;">You must be a verified creator or approved developer to submit a game. <a href="user-portal.html#verification-section">Get verified</a>.</div>
    <div id="authNotice" class="warning-message gate-block" style="display:none;">Please sign in to submit a game. <a href="index.html">Sign In</a></div>
    
    <!-- Requirements and Instructions Step -->
    <div class="requirements-card" id="requirementsCard" style="display:none;">
      <h2>Submission Requirements and Guidelines</h2>
      
      <div class="requirements-section">
        <h3>Before You Submit</h3>
        <ul class="requirements-list">
          <li>You must be a verified creator or approved developer</li>
          <li>Your game must be hosted and accessible via a public URL</li>
          <li>Ensure your game is functional and playable</li>
          <li>Have a cover image ready (16:9 aspect ratio recommended)</li>
          <li>All submissions start in draft status and require staff approval</li>
        </ul>
      </div>

      <div class="requirements-section">
        <h3>Content Guidelines</h3>
        <ul class="requirements-list">
          <li>No offensive, hateful, or inappropriate content</li>
          <li>No copyright infringement or unauthorized use of assets</li>
          <li>No malicious code, viruses, or harmful software</li>
          <li>Games must be appropriate for a general audience</li>
          <li>Respect intellectual property rights of others</li>
        </ul>
      </div>

      <div class="guidelines-box">
        <h3 style="margin-top:0; font-size:1rem;">What You Will Need</h3>
        <p><strong>Required:</strong> Game title, description, play URL</p>
        <p><strong>Optional:</strong> Cover image (upload or URL), up to 3 tags, badge (NEW/UPDATED/BETA)</p>
        <p><strong>Note:</strong> Titles are limited to 120 characters and descriptions to 1000 characters</p>
      </div>

      <div class="acceptance-box">
        <input type="checkbox" id="acceptTerms" />
        <label for="acceptTerms">I have read and agree to follow the submission guidelines and understand that my submission will be reviewed by staff before being published</label>
      </div>

      <div class="next-btn-container">
        <button id="proceedBtn" class="btn-next" disabled>Next: Basic Info</button>
      </div>
    </div>

    <!-- Step 2: Basic Game Info -->
    <div class="game-submit-card" id="basicInfoCard" style="display:none;">
      <div class="back-to-requirements">
        <button type="button" id="backToRequirements" class="btn-back">← Back to Requirements</button>
      </div>
      <h2>Basic Game Information</h2>
      <form id="basicInfoForm">
        <div class="input-container">
          <div class="input-label">Title</div>
          <input type="text" id="submissionTitle" class="neural-input" placeholder="Game Title" maxlength="120" required>
        </div>
        <div class="input-container">
          <div class="input-label">Cover Image</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <input type="file" id="submissionCoverFile" accept="image/*" style="flex:1; min-width:220px">
            <span id="submissionPreReleaseTag" class="pre-badge">BETA</span>
            <span style="opacity:.7; font-size:12px;">or</span>
            <input type="url" id="submissionCoverUrl" class="neural-input" placeholder="https://... (optional)" maxlength="2000" style="flex:1; min-width:240px">
          </div>
          <div id="submissionCoverPreviewWrap"><img id="submissionCoverPreview" alt="Cover preview" /></div>
        </div>
        <div class="input-container">
          <div class="input-label">Short Description</div>
          <textarea id="submissionDescription" class="neural-input" rows="4" placeholder="Brief description for the game card... (Max 1000 characters)" maxlength="1000" required></textarea>
          <div style="font-size:0.85rem; color:var(--gray-400); margin-top:4px;">This appears on the game card in the games library</div>
        </div>
        <div class="input-container">
          <div class="input-label">Play URL</div>
          <input type="url" id="submissionPlayUrl" class="neural-input" placeholder="https://yourgame.example.com" maxlength="2000" required>
        </div>
        <div class="input-container">
          <div class="input-label">Tags (up to 3)</div>
          <div class="tag-row">
            <input type="text" id="tag1" class="neural-input" placeholder="Tag 1" maxlength="20">
            <input type="text" id="tag2" class="neural-input" placeholder="Tag 2" maxlength="20">
            <input type="text" id="tag3" class="neural-input" placeholder="Tag 3" maxlength="20">
          </div>
        </div>
        <div class="input-container">
          <div class="input-label">Badge</div>
          <select id="submissionBadge" class="neural-input" style="max-width:260px;">
            <option value="">None</option>
            <option value="new">NEW</option>
            <option value="updated">UPDATED</option>
            <option value="beta">BETA</option>
          </select>
        </div>
        <div class="next-btn-container">
          <button type="button" id="proceedToExtended" class="btn-next">Next: Extended Details</button>
        </div>
      </form>
    </div>

    <!-- Step 3: Extended Details -->
    <div class="game-submit-card" id="extendedDetailsCard" style="display:none;">
      <div class="back-to-requirements">
        <button type="button" id="backToBasicInfo" class="btn-back">← Back to Basic Info</button>
      </div>
      <h2>Extended Details (Optional)</h2>
      <p style="color:var(--gray-400); margin-bottom:20px;">These details will appear on your game's detail page when players click the card.</p>
      <form id="submitGameForm">
        <div class="input-container">
          <div class="input-label">Extended Description</div>
          <textarea id="submissionExtendedDesc" class="neural-input" rows="8" placeholder="Provide more details about your game, features, story, gameplay mechanics... (Max 10000 characters)" maxlength="10000"></textarea>
          <div style="font-size:0.85rem; color:var(--gray-400); margin-top:4px;">Detailed game information for the dedicated detail page</div>
        </div>
        <div class="input-container">
          <div class="input-label">How to Play</div>
          <textarea id="submissionHowToPlay" class="neural-input" rows="6" placeholder="Instructions, controls, tips for players... (Max 5000 characters)" maxlength="5000"></textarea>
          <div style="font-size:0.85rem; color:var(--gray-400); margin-top:4px;">Help players learn how to play your game</div>
        </div>
        <div class="input-container">
          <div class="input-label">Screenshots (up to 10 URLs)</div>
          <input type="url" id="screenshot1" class="neural-input" placeholder="Screenshot 1 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot2" class="neural-input" placeholder="Screenshot 2 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot3" class="neural-input" placeholder="Screenshot 3 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot4" class="neural-input" placeholder="Screenshot 4 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot5" class="neural-input" placeholder="Screenshot 5 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot6" class="neural-input" placeholder="Screenshot 6 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot7" class="neural-input" placeholder="Screenshot 7 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot8" class="neural-input" placeholder="Screenshot 8 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot9" class="neural-input" placeholder="Screenshot 9 URL" maxlength="2000" style="margin-bottom:8px;">
          <input type="url" id="screenshot10" class="neural-input" placeholder="Screenshot 10 URL" maxlength="2000">
          <div style="font-size:0.85rem; color:var(--gray-400); margin-top:8px;">Screenshots will appear in a gallery on your game's detail page</div>
        </div>
        <div id="submissionMessage" style="margin:2px 0 6px;"></div>
        <div class="submit-actions">
          <button type="reset" class="btn btn-secondary">Reset All</button>
          <button id="submitGameBtn" type="submit" class="btn">Submit Game</button>
        </div>
      </form>
    </div>

    <!-- Step 4: Success Page -->
    <div class="success-card" id="successCard" style="display:none;">
      <div class="success-content">
        <div class="success-icon">✓</div>
        <h2 class="success-title">Game Submitted Successfully!</h2>
        <p class="success-message">Your game has been submitted for review. Our team will review it and publish it once approved.</p>
        
        <div class="success-details">
          <div class="success-info">
            <h3>What happens next?</h3>
            <ul>
              <li>Our moderation team will review your submission</li>
              <li>We'll check for compliance with our guidelines</li>
              <li>If approved, your game will be published to the library</li>
              <li>You'll be able to edit your game details anytime</li>
            </ul>
          </div>
          
          <div class="success-actions">
            <a href="games.html" class="btn btn-primary">View Games Library</a>
            <a href="submit-game.html" class="btn btn-secondary">Submit Another Game</a>
            <a id="viewGameBtn" href="#" class="btn btn-outline" style="display:none;">View Your Game</a>
          </div>
        </div>
      </div>
    </div>
    
    <div class="auth-redirect" id="postSubmitHint" style="display:none;">Return to the <a href="games.html">Games Library</a>.</div>
  </div>
  <div id="footer-placeholder"></div>
  <script src="script.js" defer></script>
  <script>
  (function(){
    const DEV_UIDS = new Set([
      '6iZDTXC78aVwX22qrY43BOxDRLt1',
      'YR3c4TBw09aK7yYxd7vo0AmI6iG3',
      'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
      '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
      'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
    ]);
    
    // Wait for global Firebase to be ready, or initialize if not available
    async function waitForFirebase() {
      if (window.firebaseApp && window.firebaseAuth) {
        console.log('Using global Firebase instance');
        return {
          app: window.firebaseApp,
          auth: window.firebaseAuth,
          storage: window.firebaseStorage
        };
      } else {
        console.log('Global Firebase not ready, using fallback');
        return {
          app: window.firebaseApp,
          auth: window.firebaseAuth,
          storage: window.firebaseStorage
        };
      }
    }
    
    // Check for edit mode
    const urlParams = new URLSearchParams(window.location.search);
    const editGameId = urlParams.get('edit');
    const editStep = parseInt(urlParams.get('step')) || 2; // Default to step 2 if not specified
    let isEditMode = !!editGameId;
    
    function $(id){ return document.getElementById(id); }
    async function getMe(){
      const auth = window.firebaseAuth; const user = auth?auth.currentUser:null; if(!user) return null;
      try { const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'); const db = f.getFirestore(window.firebaseApp); const snap = await f.getDoc(f.doc(db,'verified_users',user.uid)); const isVerified = snap.exists() && !!(snap.data()?.verified===true); const isDeveloper = DEV_UIDS.has(user.uid); return {uid:user.uid,isVerified,isDeveloper}; } catch { return {uid:user?.uid,isVerified:false,isDeveloper:DEV_UIDS.has(user?.uid)}; }
    }
    function show(el,flag){ if(!el) return; el.style.display = flag?'' : 'none'; }
    function updateStepIndicator(currentStep) {
      const step1 = $('step1');
      const step2 = $('step2');
      const step3 = $('step3');
      const step4 = $('step4');
      const line1 = $('line1');
      const line2 = $('line2');
      const line3 = $('line3');
      const stepIndicator = $('stepIndicator');
      
      if (!step1 || !step2 || !step3 || !step4 || !line1 || !line2 || !line3 || !stepIndicator) return;
      
      // Show step indicator
      stepIndicator.style.display = 'flex';
      
      // Reset all active states
      step1.classList.remove('active');
      step2.classList.remove('active');
      step3.classList.remove('active');
      step4.classList.remove('active');
      line1.classList.remove('completed');
      line2.classList.remove('completed');
      line3.classList.remove('completed');
      
      // Don't reset completed states - they persist based on visit history
      // Only set the current step as active
      
      if (currentStep === 1) {
        // Step 1 active (Requirements)
        step1.classList.add('active');
        // Keep step2, step3, step4 completed if they were visited (don't remove)
        // But lines are not completed since we're back at step 1
      } else if (currentStep === 2) {
        // Step 2 active (Basic Info)
        step1.classList.add('completed');
        step2.classList.add('active');
        line1.classList.add('completed');
        // Keep step3, step4 completed if they were visited (don't remove)
        // But line2, line3 are not completed since we're not past step 2
      } else if (currentStep === 3) {
        // Step 3 active (Extended Details)
        step1.classList.add('completed');
        step2.classList.add('completed');
        step3.classList.add('active');
        line1.classList.add('completed');
        line2.classList.add('completed');
        // Keep step4 completed if it was visited (don't remove)
        // But line3 is not completed since we're not at step 4
      } else if (currentStep === 4) {
        // Step 4 active (Success)
        step1.classList.add('completed');
        step2.classList.add('completed');
        step3.classList.add('completed');
        step4.classList.add('active');
        line1.classList.add('completed');
        line2.classList.add('completed');
        line3.classList.add('completed');
      }
    }
    
    function showSuccessPage(gameId, isEdit = false) {
      // Hide all other cards
      const requirementsCard = $('requirementsCard');
      const basicInfoCard = $('basicInfoCard');
      const extendedDetailsCard = $('extendedDetailsCard');
      const successCard = $('successCard');
      
      if (requirementsCard) requirementsCard.style.display = 'none';
      if (basicInfoCard) basicInfoCard.style.display = 'none';
      if (extendedDetailsCard) extendedDetailsCard.style.display = 'none';
      if (successCard) successCard.style.display = '';
      
      // Update step indicator to show step 4
      updateStepIndicator(4);
      
      // Update success page content based on edit mode
      const successTitle = successCard.querySelector('.success-title');
      const successMessage = successCard.querySelector('.success-message');
      const viewGameBtn = $('viewGameBtn');
      
      if (successTitle) {
        successTitle.textContent = isEdit ? 'Edit Successful!' : 'Game Submitted Successfully!';
      }
      
      if (successMessage) {
        successMessage.textContent = isEdit ? 
          'Your game has been updated and is now live in the library.' : 
          'Your game has been submitted for review. Our team will review it and publish it once approved.';
      }
      
      // Show and set the correct game URL for the View Game button
      if (viewGameBtn && gameId) {
        viewGameBtn.href = `game-detail.html?id=${gameId}`;
        viewGameBtn.style.display = '';
        viewGameBtn.textContent = isEdit ? 'View Updated Game' : 'View Your Submission';
      }

      // If this was an edit, remove the moderation/details block entirely and reuse the
      // existing view button so the moderation steps never appear after an edit.
      const successDetails = successCard.querySelector('.success-details');
      if (isEdit) {
        if (successTitle) successTitle.textContent = 'Edit Successful!';
        if (successMessage) successMessage.textContent = 'Your changes were saved.';

        // Ensure the View Game button is available outside the removed details block
        if (viewGameBtn && gameId) {
          viewGameBtn.href = `game-detail.html?id=${gameId}`;
          viewGameBtn.textContent = 'View Updated Game';
          viewGameBtn.style.display = '';
          // Move viewGameBtn to be a direct child of successCard (so it remains visible)
          try { successCard.appendChild(viewGameBtn); } catch (e) { /* ignore */ }
        }

        // Also show a simple library link
        const libLink = document.createElement('a');
        libLink.href = 'games.html';
        libLink.className = 'btn btn-primary';
        libLink.textContent = 'View Library';
        // Avoid duplicating if already added
        if (!successCard.querySelector('.btn.btn-primary[__gr_lib]')) {
          libLink.setAttribute('__gr_lib','1');
          successCard.appendChild(libLink);
        }

        // Remove the details block so moderation text cannot reappear
        if (successDetails && successDetails.parentNode) {
          successDetails.parentNode.removeChild(successDetails);
        }
      } else {
        // New submission - ensure the full details block is visible
        if (successDetails) successDetails.style.display = '';
      }
      
      // Scroll to top smoothly
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    async function loadGameForEdit() {
      if (!isEditMode || !editGameId) return;
      
      try {
        const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const db = f.getFirestore(window.firebaseApp);
        const auth = window.firebaseAuth;
        const user = auth?.currentUser;
        
        if (!user) {
          console.error('User not logged in');
          return;
        }
        
        const gameRef = f.doc(db, 'game_submissions', editGameId);
        const gameSnap = await f.getDoc(gameRef);
        
        if (!gameSnap.exists()) {
          alert('Game not found');
          window.location.href = 'submit-game.html';
          return;
        }
        
        const game = gameSnap.data();
        const isDeveloper = DEV_UIDS.has(user.uid);
        const isOwner = game.ownerId === user.uid;
        
        if (!isDeveloper && !isOwner) {
          alert('You do not have permission to edit this game');
          window.location.href = 'games.html';
          return;
        }
        
        // Populate form fields
        if (game.title) $('submissionTitle').value = game.title;
        if (game.description) $('submissionDescription').value = game.description;
        if (game.playUrl) $('submissionPlayUrl').value = game.playUrl;
        if (game.coverImageUrl) {
          $('submissionCoverUrl').value = game.coverImageUrl;
          // Store the original cover URL so we can detect if it changed
          window._originalCoverUrl = game.coverImageUrl;
        }
        if (game.extendedDescription) $('submissionExtendedDesc').value = game.extendedDescription;
        if (game.howToPlay) $('submissionHowToPlay').value = game.howToPlay;
        
        // Populate tags
        if (game.tags && Array.isArray(game.tags)) {
          if (game.tags[0]) $('tag1').value = game.tags[0];
          if (game.tags[1]) $('tag2').value = game.tags[1];
          if (game.tags[2]) $('tag3').value = game.tags[2];
        }
        
        // Populate screenshots
        if (game.screenshots && Array.isArray(game.screenshots)) {
          game.screenshots.forEach((url, i) => {
            const input = $(`screenshot${i + 1}`);
            if (input) input.value = url;
          });
        }
        
        
        // Update page title
        document.title = 'Edit Game - GlitchRealm';
        
        // Update page header
        const pageMainTitle = $('pageMainTitle');
        const pageSubtitle = $('pageSubtitle');
        if (pageMainTitle) pageMainTitle.textContent = 'Edit Your Game';
        if (pageSubtitle) pageSubtitle.innerHTML = 'Update your game details below. Changes will be saved to your existing submission.';
        
        // Update submit button text
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Update Game';
        
        // Auto-accept terms and navigate to the requested step
        // Wait a bit for DOMContentLoaded to set up the state
        setTimeout(() => {
          const acceptTerms = $('acceptTerms');
          if (acceptTerms) {
            acceptTerms.checked = true;
            if (window.grSubmitState?.setTermsAccepted) {
              window.grSubmitState.setTermsAccepted(true);
            }
          }
          
          // Navigate to the specified step (2 = Basic Info, 3 = Extended Details)
          const requirementsCard = $('requirementsCard');
          const basicInfoCard = $('basicInfoCard');
          const extendedDetailsCard = $('extendedDetailsCard');
          
          if (editStep === 3) {
            // Step 3 - Extended Details (from detail page)
            if (requirementsCard) requirementsCard.style.display = 'none';
            if (basicInfoCard) basicInfoCard.style.display = 'none';
            if (extendedDetailsCard) extendedDetailsCard.style.display = '';
            updateStepIndicator(3);
            if (window.grSubmitState?.setStep3Visited) {
              window.grSubmitState.setStep3Visited(true);
            }
          } else {
            // Step 2 - Basic Info (from game cards, default)
            if (requirementsCard) requirementsCard.style.display = 'none';
            if (basicInfoCard) basicInfoCard.style.display = '';
            if (extendedDetailsCard) extendedDetailsCard.style.display = 'none';
            updateStepIndicator(2);
          }
        }, 100);
        
      } catch (error) {
        console.error('Error loading game for edit:', error);
        alert('Error loading game data');
      }
    }
    
    async function gate(){
      const auth = window.firebaseAuth; const user = auth?auth.currentUser:null;
      const requirementsCard = $('requirementsCard'); 
      const basicInfoCard = $('basicInfoCard'); 
      const extendedDetailsCard = $('extendedDetailsCard');
      const gateNotice = $('gateNotice'); 
      const authNotice = $('authNotice');
      
      if(!user){ 
        show(requirementsCard,false); 
        show(basicInfoCard,false); 
        show(extendedDetailsCard,false); 
        show(authNotice,true); 
        show(gateNotice,false); 
        show($('stepIndicator'),false); 
        return; 
      }
      show(authNotice,false);
      try{ 
        const me = await getMe(); 
        const allowed = me && (me.isVerified || me.isDeveloper); 
        show(requirementsCard, allowed); 
        show(basicInfoCard, false); 
        show(extendedDetailsCard, false); 
        show(gateNotice, !allowed); 
        if(allowed) {
          updateStepIndicator(1);
          // Load game data in edit mode
          if (isEditMode) {
            await loadGameForEdit();
          }
        }
        else show($('stepIndicator'),false); 
      } catch { 
        show(requirementsCard,false); 
        show(basicInfoCard,false); 
        show(extendedDetailsCard,false); 
        show(gateNotice,true); 
        show($('stepIndicator'),false); 
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      // Track if user has already accepted terms and visited step 3
      let termsAlreadyAccepted = false;
      let step3Visited = false;
      
      // Make these accessible globally for edit mode
      window.grSubmitState = window.grSubmitState || {};
      window.grSubmitState.termsAlreadyAccepted = termsAlreadyAccepted;
      window.grSubmitState.step3Visited = step3Visited;
      window.grSubmitState.setTermsAccepted = (val) => { termsAlreadyAccepted = val; window.grSubmitState.termsAlreadyAccepted = val; };
      window.grSubmitState.setStep3Visited = (val) => { step3Visited = val; window.grSubmitState.step3Visited = val; };
      
      // Requirements card acceptance checkbox handler
      const acceptTerms = $('acceptTerms');
      const proceedBtn = $('proceedBtn');
      const backToRequirementsBtn = $('backToRequirements');
      const proceedToExtendedBtn = $('proceedToExtended');
      const backToBasicInfoBtn = $('backToBasicInfo');
      
      if (acceptTerms && proceedBtn) {
        acceptTerms.addEventListener('change', () => {
          proceedBtn.disabled = !acceptTerms.checked;
          // Hide tooltip when checkbox is checked
          if (acceptTerms.checked) {
            const tooltip = $('stepTooltip');
            if (tooltip) {
              tooltip.style.display = 'none';
            }
          }
        });
        
        // Step 1 -> Step 2
        proceedBtn.addEventListener('click', () => {
          const requirementsCard = $('requirementsCard');
          const basicInfoCard = $('basicInfoCard');
          if (requirementsCard && basicInfoCard) {
            requirementsCard.style.display = 'none';
            basicInfoCard.style.display = '';
            updateStepIndicator(2);
            window.scrollTo({top: 0, behavior: 'smooth'});
            // Mark that terms have been accepted and step 2 has been visited
            termsAlreadyAccepted = true;
            // Mark step 2 as completed (green) for future navigation
            const step2El = $('step2');
            if (step2El && !step2El.classList.contains('completed')) {
              step2El.classList.add('completed');
            }
          }
        });
      }
      
      // Step 2 -> Step 1
      if (backToRequirementsBtn) {
        backToRequirementsBtn.addEventListener('click', () => {
          const requirementsCard = $('requirementsCard');
          const basicInfoCard = $('basicInfoCard');
          if (requirementsCard && basicInfoCard) {
            basicInfoCard.style.display = 'none';
            requirementsCard.style.display = '';
            updateStepIndicator(1);
            window.scrollTo({top: 0, behavior: 'smooth'});
            // Keep checkbox checked if already accepted
            if (termsAlreadyAccepted && acceptTerms && proceedBtn) {
              acceptTerms.checked = true;
              proceedBtn.disabled = false;
            }
          }
        });
      }
      
      // Step 2 -> Step 3
      if (proceedToExtendedBtn) {
        proceedToExtendedBtn.addEventListener('click', () => {
          const basicInfoCard = $('basicInfoCard');
          const extendedDetailsCard = $('extendedDetailsCard');
          if (basicInfoCard && extendedDetailsCard) {
            basicInfoCard.style.display = 'none';
            extendedDetailsCard.style.display = '';
            updateStepIndicator(3);
            window.scrollTo({top: 0, behavior: 'smooth'});
            // Mark that step 3 has been visited
            step3Visited = true;
            // Mark step 3 as completed (green) for future navigation
            const step3El = $('step3');
            if (step3El && !step3El.classList.contains('completed')) {
              step3El.classList.add('completed');
            }
          }
        });
      }
      
      // Step 3 -> Step 2
      if (backToBasicInfoBtn) {
        backToBasicInfoBtn.addEventListener('click', () => {
          const basicInfoCard = $('basicInfoCard');
          const extendedDetailsCard = $('extendedDetailsCard');
          if (basicInfoCard && extendedDetailsCard) {
            extendedDetailsCard.style.display = 'none';
            basicInfoCard.style.display = '';
            updateStepIndicator(2);
            window.scrollTo({top: 0, behavior: 'smooth'});
          }
        });
      }
      
      // Function to navigate to a specific step
      function navigateToStep(targetStep) {
        const requirementsCard = $('requirementsCard');
        const basicInfoCard = $('basicInfoCard');
        const extendedDetailsCard = $('extendedDetailsCard');
        
        // Hide all cards
        if (requirementsCard) requirementsCard.style.display = 'none';
        if (basicInfoCard) basicInfoCard.style.display = 'none';
        if (extendedDetailsCard) extendedDetailsCard.style.display = 'none';
        
        // Show the target card
        if (targetStep === 1 && requirementsCard) {
          requirementsCard.style.display = '';
          // Keep checkbox checked if already accepted
          if (termsAlreadyAccepted && acceptTerms && proceedBtn) {
            acceptTerms.checked = true;
            proceedBtn.disabled = false;
          }
        } else if (targetStep === 2 && basicInfoCard) {
          basicInfoCard.style.display = '';
        } else if (targetStep === 3 && extendedDetailsCard) {
          extendedDetailsCard.style.display = '';
        }
        
        updateStepIndicator(targetStep);
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
      
      // Function to show tooltip message
      function showStepTooltip(message) {
        const tooltip = $('stepTooltip');
        if (tooltip) {
          tooltip.textContent = message;
          tooltip.style.display = '';
          // Tooltip stays visible until checkbox is checked
        }
      }
      
      // Make step numbers clickable
      const step1El = $('step1');
      const step2El = $('step2');
      const step3El = $('step3');
      
      if (step1El) {
        step1El.addEventListener('click', () => {
          // Step 1 is always clickable once the user has accessed it
          navigateToStep(1);
        });
      }
      
      if (step2El) {
        step2El.addEventListener('click', () => {
          // Can go to step 2 if:
          // 1. Terms have been accepted (to move forward from step 1)
          // 2. Or you're on step 3 (to go back)
          const acceptTerms = $('acceptTerms');
          if (termsAlreadyAccepted || (acceptTerms && acceptTerms.checked)) {
            navigateToStep(2);
            // If moving forward from step 1, mark terms as accepted
            if (!termsAlreadyAccepted) {
              termsAlreadyAccepted = true;
              if (step2El && !step2El.classList.contains('completed')) {
                step2El.classList.add('completed');
              }
            }
          } else {
            // Show tooltip if checkbox not checked
            showStepTooltip('⚠️ Must agree to requirements before continuing');
          }
        });
      }
      
      if (step3El) {
        step3El.addEventListener('click', () => {
          // Can go to step 3 if:
          // 1. Already visited (going back)
          // 2. Or you're on step 2 and want to move forward
          if (step3Visited || termsAlreadyAccepted) {
            navigateToStep(3);
            // If moving forward to step 3, mark it as visited
            if (!step3Visited) {
              step3Visited = true;
              if (step3El && !step3El.classList.contains('completed')) {
                step3El.classList.add('completed');
              }
            }
          }
        });
      }
      
      // Wait for cached auth to hydrate, then attach a listener and gate UI
      const attach = async () => {
        try {
          const { onAuthStateChanged, setPersistence, browserLocalPersistence } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          const auth = window.firebaseAuth;
          if (!auth) return false;
          try { setPersistence(auth, browserLocalPersistence).catch(()=>{}); } catch {}
          try { onAuthStateChanged(auth, () => gate()); } catch {}
          // Run once in case currentUser is already available
          gate();
          return true;
        } catch { return false; }
      };
      let attempts = 0;
      const tryAttach = () => {
        if (window.firebaseAuth) { attach(); return true; }
        return false;
      };
      if (!tryAttach()) {
        const id = setInterval(() => {
          if (tryAttach() || ++attempts > 25) {
            clearInterval(id);
            if (attempts > 25) gate(); // final fallback
          }
        }, 200);
      }
      const form = $('submitGameForm'); if(!form) return;
      const fileInput = $('submissionCoverFile'); const urlInput = $('submissionCoverUrl'); const wrap = $('submissionCoverPreviewWrap'); const img = $('submissionCoverPreview'); const preTag = $('submissionPreReleaseTag');
      const msgBox = $('submissionMessage');
      let lastBlobUrl = null;
      function showPreviewFromBlob(blobUrl){
        if(lastBlobUrl) { try{ URL.revokeObjectURL(lastBlobUrl); } catch{} }
        lastBlobUrl = blobUrl;
        if(img&&wrap){ img.src = blobUrl; wrap.style.display=''; }
        if(preTag) preTag.style.display='inline-block';
      }
      function showPreviewFromUrl(url){
        if(lastBlobUrl) { try{ URL.revokeObjectURL(lastBlobUrl); } catch{} lastBlobUrl = null; }
        if(img&&wrap){ img.src = url; wrap.style.display=''; }
        if(preTag) preTag.style.display='none';
      }
      function clearPreview(){
        if(lastBlobUrl) { try{ URL.revokeObjectURL(lastBlobUrl); } catch{} lastBlobUrl = null; }
        if(img&&wrap){ img.src=''; wrap.style.display='none'; }
        if(preTag) preTag.style.display='none';
      }
      // Basic load/error feedback for URL previews
      if(img){
        img.addEventListener('error', ()=>{
          // Only show error if we're actively trying to preview (not after form reset)
          if(wrap && wrap.style.display !== 'none' && urlInput?.value.trim()) {
            if(msgBox) msgBox.innerHTML = '<div class="error-message">Could not load the image preview. Check the URL or try another file.</div>';
          }
        });
        img.addEventListener('load', ()=>{
          // Clear any prior image error once a valid image is loaded
          if(msgBox && /image preview/i.test(msgBox.textContent||'')) msgBox.innerHTML='';
        });
      }
      fileInput?.addEventListener('change', ()=>{
        if(fileInput.files&&fileInput.files[0]){
          const url = URL.createObjectURL(fileInput.files[0]);
          showPreviewFromBlob(url);
        } else {
          clearPreview();
        }
      });
      urlInput?.addEventListener('input', ()=>{
        const val = urlInput.value.trim();
        if(/^https?:\/\//i.test(val)){
          showPreviewFromUrl(val);
        } else {
          if(!fileInput?.files?.length) clearPreview();
        }
      });
      form.addEventListener('reset', clearPreview);
      form.addEventListener('submit', async (e)=>{
        e.preventDefault(); 
        
        // Ensure Firebase is properly initialized
        const firebase = await waitForFirebase();
        const auth = firebase.auth;
        const user = auth?.currentUser;
        
        const msg = $('submissionMessage'); 
        const btn=$('submitGameBtn');
        
        if(!user){ 
          if(msg) msg.innerHTML='<div class="error-message">Please sign in first.</div>'; 
          return; 
        }
        
        console.log('Firebase initialized, user authenticated:', user.uid);
        
        // Debug authentication state
        console.log('User object:', user);
        console.log('Auth state:', {
          uid: user.uid,
          email: user.email,
          emailVerified: user.emailVerified,
          accessToken: await user.getIdToken(),
          customClaims: await user.getIdTokenResult()
        });
        // verify privilege
        try { const me = await getMe(); const allowed = me && (me.isVerified || me.isDeveloper); if(!allowed){ if(msg) msg.innerHTML='<div class="error-message">Only verified creators or developers can submit games. <a href="user-portal.html#verification-section">Request verification</a>.</div>'; return; } } catch {}
  const title=$('submissionTitle').value.trim(); 
  const description=$('submissionDescription').value.trim(); 
  const extendedDescription=$('submissionExtendedDesc').value.trim();
  const howToPlay=$('submissionHowToPlay').value.trim();
  const playUrl=$('submissionPlayUrl').value.trim(); 
  let coverImageUrl=$('submissionCoverUrl').value.trim(); 
  const tags=[ $('tag1').value.trim(), $('tag2').value.trim(), $('tag3').value.trim() ].filter(Boolean).slice(0,3); 
  const screenshots = [
    $('screenshot1')?.value.trim(),
    $('screenshot2')?.value.trim(),
    $('screenshot3')?.value.trim(),
    $('screenshot4')?.value.trim(),
    $('screenshot5')?.value.trim(),
    $('screenshot6')?.value.trim(),
    $('screenshot7')?.value.trim(),
    $('screenshot8')?.value.trim(),
    $('screenshot9')?.value.trim(),
    $('screenshot10')?.value.trim()
  ].filter(url => url && /^https?:\/\//i.test(url)).slice(0, 10);
  const file=fileInput?.files?.[0]||null; 
  const badge=($('submissionBadge')?.value||'').trim();
        if(!title){ if(msg) msg.innerHTML='<div class="error-message">Title is required.</div>'; return; }
        if(!description){ if(msg) msg.innerHTML='<div class="error-message">Description is required.</div>'; return; }
        if(!playUrl || !/^https?:\/\//i.test(playUrl)){ if(msg) msg.innerHTML='<div class="error-message">Valid Play URL required (http/https)</div>'; return; }
        try { btn.disabled=true; btn.textContent = isEditMode ? 'Updating...' : 'Submitting...';
          // Only upload a new cover image if:
          // 1. User selected a new file, OR
          // 2. User changed the URL field (not just the existing Supabase URL)
          const originalCoverUrl = window._originalCoverUrl || '';
          const shouldUploadCover = file || (coverImageUrl && coverImageUrl !== originalCoverUrl);
          
          if(shouldUploadCover){
            const safeName=(file?.name||'cover').replace(/[^a-zA-Z0-9_.-]/g,'_'); const uid=user.uid; if(!uid) throw new Error('No UID'); if(navigator && navigator.onLine===false) throw new Error('Offline');
            try {
              async function ensureSupabase(){
                if(window.grSupabase) return window.grSupabase;
                const mod= await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm');
                const createClient = mod.createClient || mod.default?.createClient;
                const SUPABASE_URL = window.GR_SUPABASE_URL || 'https://hkogcnxmrrkxggwcrqyh.supabase.co';
                const SUPABASE_ANON_KEY = window.GR_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhrb2djbnhtcnJreGdnd2NycXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTA5MDQsImV4cCI6MjA3Mjc2NjkwNH0.mOrnXNJBQLgMg1oq4zW1ySvCMXAbo-ZNAMwx59NJyxM';
                window.grSupabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                  auth: {
                    autoRefreshToken: false,
                    persistSession: false,
                    detectSessionInUrl: false
                  }
                });
                return window.grSupabase;
              }
              const supabase = await ensureSupabase(); const bucket = (window.GR_SUPABASE_BUCKET||'game-covers');
              async function uploadToSupabaseFromBlob(blob, filename){
                const contentType = blob.type || 'application/octet-stream';
                const namePart = (filename||'cover').replace(/[^a-zA-Z0-9_.-]/g,'_');
                const objectPath=`${uid}/${Date.now()}_${namePart}`;
                if(msg) msg.innerHTML='<div class="info-message">Uploading cover…</div>';
                const { error:upErr }= await supabase.storage.from(bucket).upload(objectPath, blob, {cacheControl:'3600',upsert:true,contentType});
                if(upErr){
                  const code=upErr?.status||upErr?.code||'upload_error';
                  const notFound = /Not Found|bucket/i.test(upErr.message||'');
                  const details = notFound ? 'Bucket missing or misconfigured.' : (upErr.message||'Unknown error');
                  if(msg) msg.innerHTML=`<div class=\"error-message\">Storage upload failed (${code}). ${details}</div>`;
                  throw upErr;
                }
                const { data:pub, error:pubErr } = supabase.storage.from(bucket).getPublicUrl(objectPath);
                if(pubErr){
                  const code=pubErr?.status||pubErr?.code||'public_url_error';
                  if(msg) msg.innerHTML=`<div class=\"error-message\">Public URL error (${code}). ${pubErr.message||'Unknown'}.</div>`;
                  throw pubErr;
                }
                return pub.publicUrl;
              }
              if(file){
                coverImageUrl = await uploadToSupabaseFromBlob(file, safeName);
              } else if (coverImageUrl) {
                // Fetch the remote image and upload it
                const controller = new AbortController(); const timeout = setTimeout(()=>controller.abort(), 15000);
                let resp; try{
                  resp = await fetch(coverImageUrl, { mode: 'cors', credentials: 'omit', signal: controller.signal });
                } finally { clearTimeout(timeout); }
                if(!resp || !resp.ok) throw new Error(`Failed to fetch image URL (${resp?.status||'no-status'})`);
                const ct = resp.headers.get('content-type') || '';
                if(!/^image\//i.test(ct)) throw new Error('Provided URL is not an image (content-type check failed)');
                const blob = await resp.blob();
                const urlName = (new URL(coverImageUrl)).pathname.split('/').pop() || 'remote-cover.png';
                coverImageUrl = await uploadToSupabaseFromBlob(blob, urlName);
              }
              if(msg) msg.innerHTML='<div class="info-message">Uploading cover... 100%</div>';
            } catch(uploadErr){
              // Abort submission if upload fails
              throw uploadErr;
            }
          } else if (isEditMode && originalCoverUrl) {
            // If editing and didn't upload a new cover, preserve the original
            coverImageUrl = originalCoverUrl;
          }
          // NOTE: Cover image already uploaded to Supabase above (no Firebase Storage fallback). Only metadata goes to Firestore below.
          const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const db = f.getFirestore(window.firebaseApp);
          
          // Get the verified username for the owner
          let ownerUsername = user.displayName || user.email?.split('@')[0] || 'Anonymous';
          try {
            const verifiedRef = f.doc(db, 'verified_users', user.uid);
            const verifiedSnap = await f.getDoc(verifiedRef);
            if (verifiedSnap.exists() && verifiedSnap.data().username) {
              ownerUsername = verifiedSnap.data().username;
            }
          } catch (err) {
            console.warn('Could not fetch verified username, using fallback:', err);
          }
          
          const payloadDoc = { title, ownerId:user.uid, ownerUsername, description, playUrl, createdAt: f.serverTimestamp(), updatedAt: f.serverTimestamp() };
          if (coverImageUrl && coverImageUrl.trim()) payloadDoc.coverImageUrl = coverImageUrl.trim();
          if (extendedDescription) payloadDoc.extendedDescription = extendedDescription;
          if (howToPlay) payloadDoc.howToPlay = howToPlay;
          if (Array.isArray(screenshots) && screenshots.length > 0) payloadDoc.screenshots = screenshots;
          if (Array.isArray(tags) && tags.length > 0) payloadDoc.tags = tags;
          if (badge && ['new','updated','beta'].includes(badge)) payloadDoc.badge = badge;
          
          // Add status only for new submissions (not edits)
          if (!isEditMode) {
            payloadDoc.status = 'draft';
          }
          
          console.log('Attempting Firestore write with payload:', payloadDoc);
          
          // Update or create based on edit mode
          if (isEditMode && editGameId) {
            // Update existing document
            const gameRef = f.doc(db, 'game_submissions', editGameId);
            
            // Debug: Check current user and document
            console.log('Current user UID:', user.uid);
            console.log('Edit game ID:', editGameId);
            console.log('Firestore instance:', db);
            console.log('Firestore app:', db.app);
            console.log('Project ID:', db.app.options.projectId);
            console.log('Game reference:', gameRef);
            console.log('Game reference path:', gameRef.path);
            
            // Get current document to check ownership
            const currentDoc = await f.getDoc(gameRef);
            if (currentDoc.exists()) {
              const currentData = currentDoc.data();
              console.log('Current document ownerId:', currentData.ownerId);
              console.log('Current document status:', currentData.status);
              console.log('User is owner:', user.uid === currentData.ownerId);
              
              // Check if user is developer
              const DEV_UIDS = new Set([
                '6iZDTXC78aVwX22qrY43BOxDRLt1',
                'YR3c4TBw09aK7yYxd7vo0AmI6iG3',
                'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
              ]);
              console.log('User is developer:', DEV_UIDS.has(user.uid));
              
              // Build update payload - only send fields that are changing
              const { createdAt, status, ownerId, ...updateFields } = payloadDoc;
              
              const finalPayload = {
                updatedAt: f.serverTimestamp()
              };
              
              // Only include content fields that have values (exclude immutable fields)
              for (const [key, value] of Object.entries(updateFields)) {
                if (value !== undefined && value !== null && value !== '') {
                  finalPayload[key] = value;
                }
              }
              
              console.log('Final update payload (only changed fields):', finalPayload);
              
              // Try a minimal update first to test permissions
              // Test if we can read the document first
              console.log('Testing document read access...');
              try {
                const testRead = await f.getDoc(gameRef);
                console.log('Document read successful:', testRead.exists());
              } catch (readError) {
                console.error('Document read failed:', readError);
                throw new Error('Cannot read document - check authentication');
              }
              
              // Test minimal update with explicit rule debugging
              console.log('Testing minimal update with debugging...');
              console.log('Rule conditions to check:');
              console.log('- request.auth != null:', true);
              console.log('- request.auth.uid:', user.uid);
              console.log('- resource.data.ownerId:', currentData.ownerId);
              console.log('- request.auth.uid == resource.data.ownerId:', user.uid === currentData.ownerId);
              console.log('- isDeveloper(request.auth.uid):', DEV_UIDS.has(user.uid));
              
              try {
                await f.updateDoc(gameRef, {
                  updatedAt: f.serverTimestamp()
                });
                console.log('Minimal update successful! Now trying full update...');
                
                await f.updateDoc(gameRef, finalPayload);
              } catch (minimalError) {
                console.error('Even minimal update failed:', minimalError);
                console.error('Full error details:', minimalError);
                
                // Let's try using setDoc with merge instead of updateDoc
                console.log('Trying setDoc with merge as fallback...');
                try {
                  await f.setDoc(gameRef, {
                    ...finalPayload,
                    updatedAt: f.serverTimestamp()
                  }, { merge: true });
                  console.log('setDoc with merge succeeded!');
                } catch (setDocError) {
                  console.error('setDoc with merge also failed:', setDocError);
                  throw minimalError;
                }
              }
            } else {
              console.error('Document does not exist!');
              throw new Error('Game not found');
            }

            // Show success page for edit mode
            showSuccessPage(editGameId, true);
          } else {
            // Create new document
            const docRef = await f.addDoc(f.collection(db,'game_submissions'), payloadDoc);
            // Show success page for new submission
            showSuccessPage(docRef.id, false);
          }
          
          // Reset form only for new submissions (not edits)
          if (!isEditMode) {
            form.reset(); 
            clearPreview(); 
            $('postSubmitHint').style.display='';
          }
        } catch(err){
          console.error('Firestore submission failed:', err);
          const reason = (err && (err.message || err.code)) ? `${err.code ? err.code+': ' : ''}${err.message}` : 'Unknown error';
          if(msg) msg.innerHTML=`<div class=\"error-message\">Error submitting to Firestore: ${reason}</div>`;
        } finally { 
          btn.disabled=false; 
          btn.textContent = isEditMode ? 'Update Game' : 'Submit'; 
        }
      });
    });
  })();
  </script>
</body>
<script>(function(){const c={src:'https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js',id:'glitchrealmdevs',desc:'Support me on Buy me a coffee!',msg:'Contribute to the development of GlitchRealm.',color:'#5F7FFF',pos:'Right',x:'18',y:'18'};function i(){if(document.getElementById('bmc-widget-script'))return;const s=document.createElement('script');s.id='bmc-widget-script';s.src=c.src;s.dataset.name='BMC-Widget';s.setAttribute('data-cfasync','false');s.setAttribute('data-id',c.id);s.setAttribute('data-description',c.desc);s.setAttribute('data-message',c.msg);s.setAttribute('data-color',c.color);s.setAttribute('data-position',c.pos);s.setAttribute('data-x_margin',c.x);s.setAttribute('data-y_margin',c.y);document.body.appendChild(s);}if(window.requestIdleCallback)requestIdleCallback(i,{timeout:2500});else window.addEventListener('load',()=>setTimeout(i,600));['pointerdown','keydown','scroll'].forEach(e=>window.addEventListener(e,i,{once:true,passive:true}));})();</script>
</html>

