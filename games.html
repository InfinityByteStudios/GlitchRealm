<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <!-- PWA Manifest & Theming -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00fff9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/favicon-192.png">
    <!-- Buy Me a Coffee performance hints -->
    <link rel="preconnect" href="https://cdnjs.buymeacoffee.com">
    <link rel="dns-prefetch" href="//cdnjs.buymeacoffee.com">
    <link rel="preload" as="script" href="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games - GlitchRealm Games</title>
    <!-- Google CMP + Consent Mode v2: load early (replace PUB_ID inside cmp-consent.js) -->
    <script src="cmp-consent.js"></script>
    <link rel="icon" type="image/png" href="assets/favicon-192.png">    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">    <link rel="stylesheet" href="styles.css">
    <!-- Async Google Fonts (non-render-blocking) -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap">
    </noscript>
    <!-- Async devicon CSS (non-critical) -->
    <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/devicon@latest/devicon.min.css" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/devicon@latest/devicon.min.css">
    </noscript>
    <!-- Performance: preconnect to critical third-parties -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//www.gstatic.com">
      <!-- Firebase SDK -->
    <script type="module">        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, deleteUser } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCo5hr7ULHLL_0UAAst74g8ePZxkB7OHFQ",
            authDomain: "shared-sign-in.firebaseapp.com",
            projectId: "shared-sign-in",
            storageBucket: "shared-sign-in.appspot.com",
            messagingSenderId: "332039027753",
            appId: "1:332039027753:web:aa7c6877d543bb90363038",
            measurementId: "G-KK5XVVLMVN"
        };
          const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Explicitly target the default bucket using gs:// URL
    const storage = getStorage(app, 'gs://shared-sign-in.appspot.com');
    const firestore = getFirestore(app);
        const analytics = getAnalytics(app);
        
    window.firebaseApp = app;
    window.firebaseConfig = firebaseConfig;
    window.firebaseAuth = auth;
        window.firebaseStorage = storage;
        window.firebaseFirestore = firestore;
        window.firestoreCollection = collection;
        window.firestoreAddDoc = addDoc;
        window.firestoreQuery = query;
        window.firestoreWhere = where;
        window.firestoreOrderBy = orderBy;
        window.firestoreLimit = limit;
        window.firestoreGetDocs = getDocs;
        window.deleteUser = deleteUser;
        
        // Load initial rating displays after Firebase is ready
        setTimeout(() => {
            if (typeof updateAllRatingDisplays === 'function') {
                updateAllRatingDisplays();
            }
        }, 2000);
    </script>
    <script>
    // Show "Submit your game here" CTA for verified users or developer UIDs
    (function(){
        const DEV_UIDS = new Set([
            '6iZDTXC78aVwX22qrY43BOxDRLt1',
            'YR3c4TBw09aK7yYxd7vo0AmI6iG3',
            'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
            '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
            'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
        ]);
        async function checkAndShowCTA(){
            try{
                const cta = document.getElementById('verified-submit-cta');
                if(!cta) return;
                if(!window.firebaseAuth || !window.firebaseFirestore){ return; }
                const user = window.firebaseAuth.currentUser;
                if(!user){ return; }
                // Developers always see it
                if(DEV_UIDS.has(user.uid)){ cta.style.display = 'block'; return; }
                // Check verified_users/{uid}.verified == true
                const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = f.getFirestore();
                const snap = await f.getDoc(f.doc(db,'verified_users',user.uid));
                const isVerified = snap.exists() && snap.data() && snap.data().verified === true;
                if(isVerified){ cta.style.display = 'block'; }
            }catch(e){ console.warn('CTA verification check failed:', e); }
        }
        // Run once Firebase likely initialized
        window.addEventListener('DOMContentLoaded', ()=> setTimeout(checkAndShowCTA, 1200));
        // Also react to auth state changes if available
        if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChanged === 'function'){
            window.firebaseAuth.onAuthStateChanged(()=> setTimeout(checkAndShowCTA, 600));
        }
    })();
    </script>
    <style>
    /* Performance: avoid rendering offscreen cards until scrolled into view */
    .game-card { content-visibility: auto; contain-intrinsic-size: 400px 1px; }

    /* Review button styles */
        .review-btn {
            background: linear-gradient(45deg, var(--primary-cyan), #00cc99);
            border: none;
            color: var(--dark-bg);
            padding: 4px 12px;
            margin-left: 10px;
            border-radius: 15px;
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 255, 249, 0.3);
            display: inline-block;
        }

        .review-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 249, 0.5);
            background: linear-gradient(45deg, #00cc99, var(--primary-cyan));
        }

        .review-btn:disabled {
            background: var(--gray-600);
            color: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Rating Display Styles */
        .rating-display {
            margin-left: 8px;
            display: inline-block;
            white-space: nowrap;
        }

        .avg-rating {
            color: var(--primary-yellow);
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
            white-space: nowrap;
        }

        .no-rating {
            color: var(--primary-yellow);
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
            white-space: nowrap;
        }

        /* Reviews Display Section */
        .reviews-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 245, 255, 0.05);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 8px;
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reviews-title {
            color: #00f5ff;
            font-size: 16px;
            font-weight: bold;
            margin: 0;
        }

        .reviews-count {
            color: #888;
            font-size: 12px;
        }

        .review-item {
            background: linear-gradient(135deg, rgba(5,15,22,0.85), rgba(10,45,55,0.55));
            border: 1px solid rgba(0, 245, 255, 0.18);
            border-radius: 14px;
            padding: 16px 18px 18px;
            margin-bottom: 14px;
            position: relative;
            overflow: hidden;
        }
        .review-item:before {
            content:"";
            position:absolute; inset:0; pointer-events:none;
            background: radial-gradient(circle at 12% 18%, rgba(0,255,249,0.12), transparent 60%), radial-gradient(circle at 85% 80%, rgba(0,140,255,0.12), transparent 65%);
            mix-blend-mode:screen; opacity:.9;
        }

        .review-item:last-child {
            margin-bottom: 0;
        }

        .review-header {
            display:flex; align-items:flex-start; gap:14px; margin-bottom:10px;
        }
    .review-avatar-wrap { width:32px; min-width:32px; height:32px; border-radius:50%; position:relative; overflow:hidden; box-shadow:0 0 0 1px rgba(0,255,249,0.35),0 0 6px -1px rgba(0,255,249,0.35); background:rgba(255,255,255,0.05); }
        .review-avatar { width:100%; height:100%; object-fit:cover; display:block; }
        .review-body { flex:1; display:flex; flex-direction:column; gap:6px; }
        .review-meta-line { display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; }
    .review-author { display:inline-flex; align-items:center; font-size:13px; font-weight:600; color:#fff; line-height:1; }
    .review-author strong { font-size:13px; letter-spacing:.3px; font-weight:600; color:#fff; }
    .review-verification { display:inline-flex; width:16px; height:16px; align-items:center; justify-content:center; background:none; padding:0; border-radius:50%; box-shadow:none; }
    .review-verification svg { width:14px; height:14px; fill:#00ffc3; filter:drop-shadow(0 0 4px rgba(0,255,249,0.6)); }
    .review-rating { font-size:13px; background:linear-gradient(90deg,#ffd700,#ffae00); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700; letter-spacing:.5px; }
        .review-rating small { color:#ffd700; opacity:.85; margin-left:4px; font-weight:600; }
        .review-date { color:#6d7f89; font-size:11px; letter-spacing:.4px; }
        .review-comment { font-size:13.5px; line-height:1.5; color:#d4dde0; background:rgba(255,255,255,0.03); padding:10px 12px 11px; border:1px solid rgba(0,255,249,0.08); border-radius:10px; box-shadow:0 0 0 1px rgba(0,255,249,0.05) inset; }
    .review-badges { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .review-badges > .review-author { margin-right:2px; }
    .review-verification, .user-badge, .review-moderation { display:inline-flex; align-items:center; line-height:1; }
        .user-badge { font-size:9px; letter-spacing:.6px; padding:3px 7px 3px; border-radius:20px; font-weight:700; background:linear-gradient(135deg,#0ff,#008cff); color:#031b21; box-shadow:0 0 0 1px rgba(0,255,249,0.35),0 2px 6px -2px rgba(0,255,249,0.5); text-transform:uppercase; }
        .artist-badge { background:linear-gradient(135deg,#ff68f9,#a600ff); color:#190323; box-shadow:0 0 0 1px rgba(255,0,200,0.4),0 2px 6px -2px rgba(255,0,200,0.4); }
        .developer-badge { background:linear-gradient(135deg,#00ffbf,#00b8ff); }
        .review-moderation { font-size:9px; padding:3px 6px 3px; border-radius:16px; letter-spacing:.5px; font-weight:600; }
        .review-pending { background:rgba(255,170,0,0.15); border:1px solid rgba(255,170,0,0.5); color:#ffb347; }
        .review-approved { background:rgba(0,255,170,0.15); border:1px solid rgba(0,255,170,0.45); color:#4dffc1; }
    @media (max-width:620px){ .review-header { flex-direction:row; } .review-meta-line { flex-direction:row; gap:6px; } .review-avatar-wrap { width:30px; height:30px; min-width:30px; } }

        .review-rating {
            color: #ffd700;
            font-size: 14px;
        }

        .review-date {
            color: #666;
            font-size: 11px;
        }

        .review-comment {
            color: #ccc;
            font-size: 13px;
            line-height: 1.4;
            margin: 0;
        }

        .review-moderation {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .review-approved {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .review-pending {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }

        /* User Badges */
        .user-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .developer-badge {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            animation: developerGlow 2s ease-in-out infinite alternate;
        }

        .artist-badge {
            background: linear-gradient(45deg, #ff6b9d, #c44569);
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.3);
            animation: artistGlow 2s ease-in-out infinite alternate;
        }

        @keyframes developerGlow {
            0% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
            100% { box-shadow: 0 0 15px rgba(0, 255, 0, 0.6); }
        }

        @keyframes artistGlow {
            0% { box-shadow: 0 0 5px rgba(255, 107, 157, 0.3); }
            100% { box-shadow: 0 0 15px rgba(255, 107, 157, 0.6); }
        }

        /* Developer Reply Styles */
        .developer-reply-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 245, 255, 0.2);
        }

        .developer-reply-btn {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .developer-reply-btn:hover {
            background: linear-gradient(45deg, #00cc00, #009900);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            transform: translateY(-1px);
        }

        .developer-reply-form {
            margin-top: 10px;
            background: rgba(0, 245, 255, 0.05);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 6px;
            padding: 15px;
        }

        .developer-reply-textarea {
            width: 100%;
            min-height: 60px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            padding: 8px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }

        .developer-reply-textarea:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 5px rgba(0, 245, 255, 0.3);
        }

        .developer-reply-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .cancel-reply {
            background: var(--gray-600);
            color: var(--gray-300);
        }

        .cancel-reply:hover {
            background: var(--gray-500);
        }

        .submit-reply {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
        }

        .submit-reply:hover {
            background: linear-gradient(45deg, #00cc00, #009900);
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.4);
        }

        /* Reply Display Styles */
        .review-replies {
            margin-top: 15px;
        }

        .developer-reply {
            background: rgba(0, 255, 0, 0.08);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            margin-left: 20px;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reply-author {
            color: #00ff00;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reply-author i {
            font-size: 12px;
        }

        .reply-date {
            color: #888;
            font-size: 11px;
        }

        .reply-text {
            color: #ddd;
            font-size: 13px;
            line-height: 1.4;
            margin: 0;
            font-style: italic;
        }

        /* Login Prompt Styles */
        .login-prompt {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            text-align: center;
        }

        .login-prompt p {
            color: #ccc;
            margin: 0;
            font-size: 14px;
        }

        .login-link {
            color: var(--primary-cyan);
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .login-link:hover {
            color: var(--primary-magenta);
            text-shadow: 0 0 8px var(--primary-magenta);
        }

        .reviews-loading {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .reviews-empty {
            color: #666;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        /* Modal Reviews Section */
        .modal-reviews-section {
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid rgba(0, 245, 255, 0.3);
            padding-top: 20px;
        }

        .modal-reviews-section .reviews-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .modal-reviews-section .review-item {
            margin-bottom: 15px;
            background: rgba(0, 245, 255, 0.08);
        }

        .modal-reviews-section .review-item:last-child {
            margin-bottom: 0;
        }

        /* Review Modal Styles */
        .review-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(145deg, var(--gray-800), var(--darker-bg));
            margin: 2% auto;
            padding: 30px;
            border: 2px solid var(--primary-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 249, 0.3);
            animation: modalGlitch 0.3s ease-in;
            position: relative;
            
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-cyan) rgba(0, 245, 255, 0.1);
        }

        /* Webkit browsers scrollbar styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 245, 255, 0.1);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary-cyan);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-magenta);
        }

        @keyframes modalGlitch {
            0% { transform: scale(0.8) rotateX(90deg); opacity: 0; }
            50% { transform: scale(1.05) rotateX(0deg); opacity: 0.8; }
            100% { transform: scale(1) rotateX(0deg); opacity: 1; }
        }

        .close-btn {
            color: var(--primary-cyan);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: var(--primary-magenta);
            text-shadow: 0 0 10px var(--primary-magenta);
            transform: scale(1.2);
        }

        .modal-title {
            color: var(--primary-cyan);
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 249, 0.5);
            font-family: 'Orbitron', monospace;
        }

        .game-info {
            background: rgba(0, 255, 249, 0.1);
            border: 1px solid var(--primary-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary-cyan);
            font-family: 'Orbitron', monospace;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
            font-size: 30px;
        }

        .star-container {
            position: relative;
            display: inline-block;
        }

        .star-half,
        .star-full {
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            position: absolute;
            left: 0;
            top: 0;
        }

        .star-full {
            position: relative;
        }

        .star-half {
            width: 50%;
            overflow: hidden;
            z-index: 2;
        }

        .star-half:hover,
        .star-half.active,
        .star-full:hover,
        .star-full.active {
            color: var(--primary-yellow);
            text-shadow: 0 0 15px var(--primary-yellow);
            transform: scale(1.2);
        }

        .star-half:hover,
        .star-full:hover {
            animation: starPulse 0.5s infinite alternate;
        }

        /* Legacy star class for backward compatibility */
        .star {
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: var(--primary-yellow);
            text-shadow: 0 0 15px var(--primary-yellow);
            transform: scale(1.2);
        }

        .star:hover {
            animation: starPulse 0.5s infinite alternate;
        }

        @keyframes starPulse {
            0% { transform: scale(1.2); }
            100% { transform: scale(1.4); }
        }

        .comment-section {
            margin: 20px 0;
        }

        .comment-label {
            color: var(--primary-cyan);
            font-size: 16px;
            margin-bottom: 10px;
            display: block;
            font-family: 'Orbitron', monospace;
        }

        .comment-textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--primary-cyan);
            border-radius: 8px;
            color: var(--white);
            padding: 15px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }

        .comment-textarea:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 249, 0.3);
            border-color: var(--primary-cyan);
        }

        .character-counter {
            text-align: right;
            color: var(--gray-400);
            font-size: 12px;
            margin-top: 5px;
            font-family: 'Rajdhani', sans-serif;
        }

        .character-counter.warning {
            color: var(--warning);
        }

        .character-counter.error {
            color: var(--danger);
        }

        .submit-section {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .submit-section .btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .submit-btn {
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--primary-cyan);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(0, 255, 249, 0.5);
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .cancel-btn {
            border-color: var(--primary-magenta);
            color: var(--primary-magenta);
        }

        .cancel-btn:hover {
            background: var(--primary-magenta);
            color: var(--white);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
        }

        .success-message {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 15px;
            color: var(--success);
            margin: 15px 0;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
        }

        .warning-message {
            background: rgba(255, 184, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 15px;
            color: var(--warning);
            margin: 15px 0;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
        }

        .error-message {
            background: rgba(255, 7, 58, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            color: var(--danger);
            margin: 15px 0;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-cyan);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sign-in Error Modal Styles */
        .error-modal {
            border-color: var(--danger) !important;
            box-shadow: 0 0 30px rgba(255, 7, 58, 0.3) !important;
        }

        .error-title {
            color: var(--danger) !important;
            text-shadow: 0 0 10px rgba(255, 7, 58, 0.5) !important;
        }

        .error-icon {
            text-align: center;
            margin: 20px 0;
            color: var(--danger);
            animation: errorPulse 2s ease-in-out infinite alternate;
        }

        @keyframes errorPulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        .error-info {
            text-align: center;
            margin: 20px 0;
        }

        .error-message-text {
            color: var(--danger);
            font-size: 16px;
            font-family: 'Orbitron', monospace;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .error-sub-text {
            color: var(--gray-400);
            font-size: 14px;
            font-family: 'Rajdhani', sans-serif;
            line-height: 1.5;
        }

        .signin-btn {
            border-color: var(--success) !important;
            color: var(--success) !important;
        }

        .signin-btn:hover {
            background: var(--success) !important;
            color: var(--dark-bg) !important;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5) !important;
        }

        /* Force proper styling for profile dropdown */
        .user-profile {
            position: relative !important;
        }

        .profile-dropdown {
            position: relative !important;
        }

        .profile-trigger {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            background: rgba(0, 255, 249, 0.1) !important;
            border: 1px solid var(--primary-cyan) !important;
            border-radius: 8px !important;
            padding: 0.5rem 0.75rem !important;
            color: var(--white) !important;
            font-family: 'Rajdhani', sans-serif !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        .profile-trigger:hover {
            background: rgba(0, 255, 249, 0.2) !important;
            box-shadow: 0 0 15px rgba(0, 255, 249, 0.3) !important;
        }

        .user-avatar {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            border: 2px solid var(--primary-cyan) !important;
            object-fit: cover !important;
        }

        /* Avatar upload overlay styles */
        .user-avatar-container {
            position: relative !important;
            display: inline-block !important;
        }

        .avatar-upload-overlay {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(4px) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            cursor: pointer !important;
            z-index: 10 !important;
        }

        .user-avatar-container:hover .avatar-upload-overlay {
            opacity: 0 !important;
        }

        /* Only show upload overlay when dropdown is open */
        .profile-dropdown.active .user-avatar-container:hover .avatar-upload-overlay {
            opacity: 1 !important;
        }

        .upload-icon {
            font-size: 14px !important;
            color: rgba(255, 255, 255, 0.9) !important;
            text-shadow: 0 0 10px rgba(0, 255, 249, 0.5) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .upload-icon svg {
            width: 16px !important;
            height: 16px !important;
            fill: currentColor !important;
        }

        .user-avatar-large-container {
            position: relative !important;
            display: inline-block !important;
        }

        .avatar-upload-overlay-large {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(6px) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            cursor: pointer !important;
            z-index: 10 !important;
        }

        .user-avatar-large-container:hover .avatar-upload-overlay-large {
            opacity: 0 !important;
        }

        /* Only show large upload overlay when dropdown is open */
        .profile-dropdown.active .user-avatar-large-container:hover .avatar-upload-overlay-large {
            opacity: 1 !important;
        }

        .upload-icon-large {
            font-size: 24px !important;
            color: rgba(255, 255, 255, 0.9) !important;
            text-shadow: 0 0 15px rgba(0, 255, 249, 0.7) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .upload-icon-large svg {
            width: 28px !important;
            height: 28px !important;
            fill: currentColor !important;
        }

        .user-name {
            font-size: 0.9rem !important;
            max-width: 120px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        .dropdown-arrow {
            font-size: 0.8rem !important;
            color: var(--primary-cyan) !important;
            transition: transform 0.3s ease !important;
        }

        .profile-dropdown.open .dropdown-arrow {
            transform: rotate(180deg) !important;
        }

        .profile-menu {
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            background: linear-gradient(135deg, #0a1629 0%, #041018 100%) !important;
            border: 2px solid var(--primary-cyan) !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 255, 249, 0.3) !important;
            min-width: 280px !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            z-index: 10000 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(-10px) scale(0.95) !important;
            transition: all 0.3s ease !important;
            margin-top: 0.5rem !important;
        }

        .profile-dropdown.open .profile-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) scale(1) !important;
        }

        .profile-info {
            padding: 1.5rem !important;
            border-bottom: 1px solid rgba(0, 255, 249, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
        }

        .user-avatar-large {
            width: 60px !important;
            height: 60px !important;
            border-radius: 50% !important;
            border: 3px solid var(--primary-cyan) !important;
            object-fit: cover !important;
        }

        .profile-details {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 0.25rem !important;
        }

        .user-display-name {
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            color: var(--white) !important;
        }

        .user-email {
            font-size: 0.85rem !important;
            color: var(--primary-cyan) !important;
            opacity: 0.8 !important;
        }

        .user-provider {
            font-size: 0.75rem !important;
            color: var(--primary-magenta) !important;
            text-transform: uppercase !important;
            font-weight: 600 !important;
        }

        .profile-actions {
            padding: 1rem 1.5rem !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
        }

        .profile-action-btn {
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;
            color: var(--white) !important;
            font-family: 'Rajdhani', sans-serif !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-align: left !important;
            width: 100% !important;
        }

        .profile-action-btn:hover {
            transform: translateX(5px) !important;
        }

        /* Ensure sign out button text is visible */
        .profile-action-btn.sign-out {
            color: var(--white) !important;
        }

        /* More specific rule for sign out button text */
        #sign-out-btn,
        #sign-out-btn *:not(.action-icon):not(.icon-svg):not(path) {
            color: var(--white) !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .profile-action-btn.sign-out:hover {
            background: rgba(0, 255, 249, 0.1) !important;
            border-color: var(--primary-cyan) !important;
            color: var(--primary-cyan) !important;
        }

        .profile-action-btn.delete-account:hover {
            background: rgba(255, 7, 58, 0.1) !important;
            border-color: var(--danger) !important;
            color: var(--danger) !important;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Tip text styling */
        .remember-tip {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(0, 255, 249, 0.1);
            border: 1px solid rgba(0, 255, 249, 0.3);
            border-radius: 6px;
            font-size: 12px;
        }

        .tip-text {
            color: var(--primary-cyan);
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tip-icon {
            fill: var(--primary-cyan);
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    
    <div id="header-placeholder"></div>

    <main class="main">
        <section class="games-hero">
            <div class="container">
                <h1 class="page-title">
                    <span class="glitch" data-text="Our Games">Our Games</span>
                </h1>
                <p class="page-subtitle">Enter the digital realm and explore our cyberpunk gaming universe</p>
                <p id="verified-submit-cta" class="page-subtitle" style="display:none; font-size:0.95rem;">
                    Submit your game <a href="submit-game.html" style="text-decoration:underline; color: var(--primary-cyan);">here</a>.
                </p>
            </div>
        </section>        <section class="games-grid">
            <div class="container">
                <div class="game-cards">
                    <!-- ByteSurge Game Card -->
                    <div class="game-card" data-game="bytesurge">
                        <div class="card-image">
                            <img src="assets/Game Logos/ByteSurge.png" alt="ByteSurge" class="game-logo-image" loading="lazy" decoding="async">
                            <div class="card-overlay"></div>
                            <div class="game-badge new">NEW</div>
                            <!-- Game Card Menu Buttons (top right) -->
                            <div class="game-card-menu" data-game-menu>
                                <button class="menu-btn edit-btn" data-action="edit" title="Edit Game" style="display:none;">‚úèÔ∏è Edit</button>
                                <button class="menu-btn delete-btn" data-action="delete" title="Delete Game" style="display:none;">üóëÔ∏è Delete</button>
                                <button class="menu-btn report-btn" data-action="report" title="Report Game" style="display:none;">üö© Report</button>
                                <button class="menu-btn three-dot-btn" data-action="report" title="Report Game" style="display:none;">‚ãÆ</button>
                            </div>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">ByteSurge</h3>
                            <p class="card-description">Ride the digital waves in this high-speed cyberpunk racing adventure. Master the art of data surfing through neon-lit networks.</p>
                            <p class="card-developer">Made by <a href="about.html"><strong>NanoShade Studios</strong></a> <button class="review-btn" onclick="openReviewModal('bytesurge', 'ByteSurge')">‚≠ê Review</button><span class="rating-display" data-game-id="bytesurge"><span class="no-rating">N/A (0)</span></span></p>                            <div class="card-tags">
                                <span class="tag">Racing</span>
                                <span class="tag">Speed</span>
                                <span class="tag">Cyberpunk</span>
                                <i class="devicon-linux-plain platform-icon" title="Works on Linux"></i>
                                <i class="devicon-windows8-original platform-icon" title="Works on Windows"></i>
                                <i class="devicon-apple-original platform-icon" title="Works on macOS"></i>
                            </div>
                            <button onclick="showGameOptionsModal('bytesurge', 'ByteSurge', 'Games/ByteSurge/index.html', 'https://bytesurgeloop.netlify.app/')" class="btn btn-primary card-btn">Play Now</button>
                                
                        </div>
                    </div>

                    <!-- NeuroCore: Byte Wars Game Card -->
                    <div class="game-card" data-game="neurocore">                        <div class="card-image">
                            <img src="assets/Game Logos/NeuroCore Byte Wars Logo.png" alt="NeuroCore: Byte Wars" class="game-logo-image" loading="lazy" decoding="async">
                            <div class="card-overlay"></div>
                            <div class="game-badge coming-soon" style="display: none;">UPDATE SOON</div>
                            <!-- Game Card Menu Buttons (top right) -->
                            <div class="game-card-menu" data-game-menu>
                                <button class="menu-btn edit-btn" data-action="edit" title="Edit Game" style="display:none;">‚úèÔ∏è Edit</button>
                                <button class="menu-btn delete-btn" data-action="delete" title="Delete Game" style="display:none;">üóëÔ∏è Delete</button>
                                <button class="menu-btn report-btn" data-action="report" title="Report Game" style="display:none;">üö© Report</button>
                                <button class="menu-btn three-dot-btn" data-action="report" title="Report Game" style="display:none;">‚ãÆ</button>
                            </div>
                        </div>                        <div class="card-content">
                            <h3 class="card-title">NeuroCore: Byte Wars</h3>
                            <p class="card-description">Engage in neural combat using advanced algorithms. Battle through digital networks in this strategic warfare game.</p>
                            <p class="card-developer">Made by <a href="about.html"><strong>InfinityByte Studios</strong></a> <button class="review-btn" onclick="openReviewModal('neurocore', 'NeuroCore: Byte Wars')">‚≠ê Review</button><span class="rating-display" data-game-id="neurocore"><span class="no-rating">N/A (0)</span></span></p>                            <div class="card-tags">
                                <span class="tag">Strategy</span>
                                <span class="tag">Combat</span>
                                <span class="tag">Sci-Fi</span>
                                <i class="devicon-linux-plain platform-icon" title="Works on Linux"></i>
                                <i class="devicon-windows8-original platform-icon" title="Works on Windows"></i>
                                <i class="devicon-apple-original platform-icon" title="Works on macOS"></i>
                            </div>
                            <button onclick="showGameOptionsModal('neurocore', 'NeuroCore: Byte Wars', 'Games/ByteWars/index.html', 'https://neurocorebytewars.netlify.app/')" class="btn btn-primary card-btn">Play Now</button>
                                
                        </div>
                    </div>

                    <!-- CodeRunner Game Card -->
                    <div class="game-card" data-game="coderunner">
                        <div class="card-image">
                            <img src="assets/Game Logos/CodeRunner Logo.png" alt="CodeRunner" class="game-logo-image" loading="lazy" decoding="async">
                            <div class="card-overlay"></div>
                            
                            <!-- Game Card Menu Buttons (top right) -->
                            <div class="game-card-menu" data-game-menu style="position:absolute; top:10px; right:10px; z-index:10; display:flex; flex-direction:column; gap:8px;">
                                <button class="menu-btn edit-btn" data-action="edit" title="Edit Game" style="display:none; background:rgba(0,255,249,0.85); color:#041018; border:none; border-radius:8px; padding:6px 14px; font-size:15px; font-family:'Orbitron',sans-serif; box-shadow:0 2px 8px rgba(0,255,249,0.18); cursor:pointer; transition:background 0.2s;">‚úèÔ∏è Edit</button>
                                <button class="menu-btn delete-btn" data-action="delete" title="Delete Game" style="display:none; background:rgba(255,0,128,0.85); color:#fff; border:none; border-radius:8px; padding:6px 14px; font-size:15px; font-family:'Orbitron',sans-serif; box-shadow:0 2px 8px rgba(255,0,128,0.18); cursor:pointer; transition:background 0.2s;">üóëÔ∏è Delete</button>
                                <button class="menu-btn report-btn" data-action="report" title="Report Game" style="display:none; background:rgba(255,215,0,0.85); color:#041018; border:none; border-radius:8px; padding:6px 14px; font-size:15px; font-family:'Orbitron',sans-serif; box-shadow:0 2px 8px rgba(255,215,0,0.18); cursor:pointer; transition:background 0.2s;">üö© Report</button>
                                <button class="menu-btn three-dot-btn" data-action="report" title="Report Game" style="display:none; background:rgba(0,0,0,0.7); color:#fff; border:none; border-radius:50%; width:38px; height:38px; font-size:22px; font-family:'Orbitron',sans-serif; box-shadow:0 2px 8px rgba(0,0,0,0.18); cursor:pointer; transition:background 0.2s; align-self:flex-end;">‚ãÆ</button>
                            </div>
                        </div><div class="card-content">                            <h3 class="card-title">CodeRunner</h3>
                            <p class="card-description">Navigate through digital mazes while solving programming challenges. Race against time in this cyberpunk coding adventure.</p>
                            <p class="card-developer">Made by <a href="about.html"><strong>NanoShade Studios</strong></a> <button class="review-btn" onclick="openReviewModal('coderunner', 'CodeRunner')">‚≠ê Review</button><span class="rating-display" data-game-id="coderunner"><span class="no-rating">N/A (0)</span></span></p>                            <div class="card-tags">
                                <span class="tag">Puzzle</span>
                                <span class="tag">Coding</span>
                                <span class="tag">Adventure</span>
                                <i class="devicon-linux-plain platform-icon" title="Works on Linux"></i>
                                <i class="devicon-windows8-original platform-icon" title="Works on Windows"></i>
                                <i class="devicon-apple-original platform-icon" title="Works on macOS (doesn't work well in Safari)"></i>
                            </div>
                            <button onclick="showGameOptionsModal('coderunner', 'CodeRunner', 'Games/CodeRunner/index.html', 'https://coderunner-quest.netlify.app/')" class="btn btn-primary card-btn">Play Now</button>
                                <!-- Game Card Menu Buttons -->
                                <div class="game-card-menu" data-game-menu>
                                    <button class="menu-btn edit-btn" data-action="edit" title="Edit Game" style="display:none;"><span>‚úèÔ∏è Edit</span></button>
                                    <button class="menu-btn delete-btn" data-action="delete" title="Delete Game" style="display:none;"><span>üóëÔ∏è Delete</span></button>
                                    <button class="menu-btn report-btn" data-action="report" title="Report Game" style="display:none;"><span>üö© Report</span></button>
                                    <button class="menu-btn three-dot-btn" data-action="report" title="Report Game" style="display:none;"><span>‚ãÆ</span></button>
                                </div>
                        </div>
                    </div>

                    <!-- Coming Soon Game Card -->
                    <div class="game-card coming-soon" data-game="comingsoon">
                        <div class="card-image">
                            <div class="image-placeholder">                                <span class="game-icon">
                                    <svg class="icon-svg" viewBox="0 0 24 24">
                                        <path d="M4,6H20V16H4M20,18A2,2 0 0,0 22,16V6C22,4.89 21.1,4 20,4H4C2.89,4 2,4.89 2,6V16A2,2 0 0,0 4,18H0V20H24V20H20Z"/>
                                    </svg>
                                    <svg class="icon-svg" viewBox="0 0 24 24">
                                        <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A0.5,0.5 0 0,0 7,13.5A0.5,0.5 0 0,0 7.5,14A0.5,0.5 0 0,0 8,13.5A0.5,0.5 0 0,0 7.5,13M16.5,13A0.5,0.5 0 0,0 16,13.5A0.5,0.5 0 0,0 16.5,14A0.5,0.5 0 0,0 17,13.5A0.5,0.5 0 0,0 16.5,13Z"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="card-overlay"></div>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">More Games Coming Soon...</h3>
                            <p class="card-description">The digital realm is expanding. New adventures await in the depths of cyberspace. Stay tuned for updates.</p>
                            <div class="card-tags">
                                <span class="tag">Mystery</span>
                                <span class="tag">Soon‚Ñ¢</span>
                            </div>
                            <button class="btn btn-disabled card-btn" disabled>Under Development</button>
                        </div>
                    </div>

                    <!-- Submit Your Game (Visible to Verified Users or Dev UIDs) -->
                    <div id="submitGameCard" class="game-card" style="display:none" data-game="submit">
                        <div class="card-image">
                            <div class="image-placeholder">
                                <span class="game-icon">
                                    <svg class="icon-svg" viewBox="0 0 24 24">
                                        <path d="M4,3H20A1,1 0 0,1 21,4V16A1,1 0 0,1 20,17H4A1,1 0 0,1 3,16V4A1,1 0 0,1 4,3M5,5V15H19V5H5M6,19H18V21H6V19Z"/>
                                    </svg>
                                    <svg class="icon-svg" viewBox="0 0 24 24">
                                        <path d="M12,2A10,10 0 0,1 22,12C22,17.5 17.5,22 12,22A10,10 0 0,1 2,12C2,6.5 6.5,2 12,2M11,6V11H6V13H11V18H13V13H18V11H13V6H11Z"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="card-overlay"></div>
                            <div class="game-badge new">CREATOR</div>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Submit Your Game</h3>
                            <p class="card-description">Verified creators or approved developers can submit a new game to appear on this page.</p>
                            <div class="card-tags">
                                <span class="tag">Indie</span>
                                <span class="tag">Community</span>
                                <span class="tag">Creator</span>
                            </div>
                            <a href="submit-game.html" class="btn btn-primary card-btn">Start Submission</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Sign In Modal is now provided by header.html -->

    <!-- Delete Account Confirmation Modal -->
    <div id="delete-account-modal" class="auth-overlay" style="display: none;">
        <div class="auth-panel danger">
            <div class="auth-header warning">
                <div class="auth-logo">
                        <span class="glitch-constant" data-text="‚ö† ACCOUNT DELETION ‚ö†">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z"/>
                        </svg>
                            ACCOUNT DELETION 
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z"/>
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="auth-content">
                <div class="warning-message">
                    <p class="warning-text">This action will permanently delete your account and all associated data.</p>
                    <p class="danger-text">This operation cannot be undone.</p>
                </div>
                
                <div class="confirmation-input">
                    <div class="input-container danger">
                        <div class="input-label">Type "DELETE MY ACCOUNT" to confirm:</div>
                        <input type="text" id="delete-confirmation-input" class="neural-input danger" placeholder="DELETE MY ACCOUNT">
                        <div class="input-line danger"></div>
                    </div>
                </div>
                
                <div class="warning-actions">
                    <button id="cancel-delete" class="neural-button secondary">
                        <span class="button-text">CANCEL ACCOUNT DELETION</span>
                        <div class="button-glow"></div>
                    </button>
                    <button id="confirm-delete" class="neural-button danger">
                        <span class="button-text">DELETE ACCOUNT</span>
                        <div class="button-glow danger"></div>
                    </button>
                </div>
            </div>
            
            <div class="auth-bg-effect warning"></div>
            <div class="auth-scanlines warning"></div>
        </div>    </div>

    <!-- Game Options Modal -->
    <div id="gameOptionsModal" class="auth-overlay" style="display: none;">
        <div class="auth-panel game-options-panel">
            <div class="auth-header">
                <div class="auth-logo">
                    <span class="glitch-constant" data-text="LAUNCH OPTIONS">LAUNCH OPTIONS</span>
                </div>
                <button class="auth-close" onclick="closeGameOptionsModal()">
                    <span class="close-icon">√ó</span>
                </button>
            </div>
            
            <div class="auth-content">
                <div class="game-options-content">
                    <div class="form-title">
                        <span class="glitch-small" data-text="CHOOSE YOUR EXPERIENCE">CHOOSE YOUR EXPERIENCE</span>
                    </div>
                    
                    <div class="game-info-display">
                        <h3 id="gameOptionsTitle">Game Name</h3>
                        <p class="game-launch-subtitle">Select how you'd like to play this game:</p>
                    </div>
                    
                    <div class="launch-options">
                        <button id="localGameBtn" class="neural-button primary launch-option">
                            <div class="launch-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M4,6H20V16H4M20,18A2,2 0 0,0 22,16V6C22,4.89 21.1,4 20,4H4C2.89,4 2,4.89 2,6V16A2,2 0 0,0 4,18H0V20H24V20H20Z"/>
                                </svg>
                            </div>
                            <div class="launch-text">
                                <span class="launch-title">PLAY IN GLITCHREALM</span>
                                <span class="launch-desc">Stay in the cyberpunk realm</span>
                                <div class="outdated-badge">‚ö† Outdated Version</div>
                            </div>
                            <div class="button-glow"></div>
                        </button>
                        
                        <button id="externalGameBtn" class="neural-button secondary launch-option">
                            <div class="launch-icon">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                                </svg>
                            </div>
                            <div class="launch-text">
                                <span class="launch-title">VISIT FULL SITE</span>
                                <span class="launch-desc">Latest version - opens in new tab</span>
                            </div>
                            <div class="button-glow"></div>
                        </button>
                    </div>
                    
                    <div class="remember-option">
                        <label class="remember-checkbox">
                            <input type="checkbox" id="rememberChoice">
                            <span class="checkmark"></span>
                            <span class="checkbox-text">Remember my choice</span>
                        </label>
                        <div class="remember-tip">
                            <span class="tip-text">
                                <svg class="tip-icon" viewBox="0 0 24 24" width="14" height="14">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17C11.45,17 11,16.55 11,16C11,15.45 11.45,15 12,15C12.55,15 13,15.45 13,16C13,16.55 12.55,17 12,17M12,7A1.5,1.5 0 0,1 13.5,8.5C13.5,9.25 13.17,9.9 12.71,10.36L12.41,10.66C12.15,10.92 12,11.28 12,11.66V13H10V11.66C10,10.85 10.35,10.09 10.93,9.51L11.24,9.2C11.46,8.98 11.5,8.77 11.5,8.5A0.5,0.5 0 0,0 11,8A0.5,0.5 0 0,0 10.5,8.5H9A1.5,1.5 0 0,1 10.5,7H12Z"/>
                                </svg>
                                Tip: You can change this later in settings under the user dropdown menu
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auth-bg-effect"></div>
            <div class="auth-scanlines"></div>
        </div>
    </div>

    <div id="auth-message" class="auth-message" style="display: none;"></div>
    <div id="auth-loading" class="auth-loading" style="display: none;">
        <div class="loading-spinner"></div>
        <span>Connecting...</span>
    </div>

    <!-- Game Removed Modal -->
    <div id="gameRemovedModal" class="review-modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeGameRemovedModal()">&times;</span>
            <h2 class="modal-title">GAME REMOVED</h2>
            <div class="game-info">
                <strong id="removedGameName">Game Name</strong>
            </div>
            <div class="error-info">
                <p class="error-message-text" style="margin-top:8px;">
                    This game was removed due to violation of GlitchRealm‚Äôs Terms of Service and Privacy Policy, including failure to maintain basic functionality and compliance. If you have questions or need more information, please contact InfinityByte Studio / GlitchRealm.
                </p>
            </div>
            <div class="submit-section">
                <button class="btn cancel-btn" onclick="closeGameRemovedModal()">Close</button>
                <a class="btn submit-btn" href="contact.html">Contact Us</a>
            </div>
        </div>
    </div>

    <!-- Submit Game Modal removed: feature moved to standalone submit-game.html -->

    <!-- Review Modal -->
    <div id="reviewModal" class="review-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeReviewModal()">&times;</span>
            <h2 class="modal-title">LEAVE A REVIEW</h2>
            
            <div class="game-info">
                <strong id="reviewGameName">Game Name</strong>
            </div>

            <div class="star-rating">
                <div class="star-container">
                    <span class="star-half" data-rating="0.5">‚òÜ</span>
                    <span class="star-full" data-rating="1">‚òÖ</span>
                </div>
                <div class="star-container">
                    <span class="star-half" data-rating="1.5">‚òÜ</span>
                    <span class="star-full" data-rating="2">‚òÖ</span>
                </div>
                <div class="star-container">
                    <span class="star-half" data-rating="2.5">‚òÜ</span>
                    <span class="star-full" data-rating="3">‚òÖ</span>
                </div>
                <div class="star-container">
                    <span class="star-half" data-rating="3.5">‚òÜ</span>
                    <span class="star-full" data-rating="4">‚òÖ</span>
                </div>
                <div class="star-container">
                    <span class="star-half" data-rating="4.5">‚òÜ</span>
                    <span class="star-full" data-rating="5">‚òÖ</span>
                </div>
            </div>

            <div class="comment-section">
                <label class="comment-label">Your Review (Optional):</label>
                <textarea 
                    id="reviewComment" 
                    class="comment-textarea" 
                    placeholder="Share your thoughts about this game... (Max 500 characters)"
                    maxlength="500"></textarea>
                <div id="charCounter" class="character-counter">0/500</div>
            </div>

            <div id="reviewMessage"></div>

            <div class="submit-section">
                <button class="btn cancel-btn" onclick="closeReviewModal()">Cancel</button>
                <button id="submitReview" class="btn submit-btn" onclick="submitReview()">Submit Review</button>
            </div>

            <!-- Reviews Section in Modal -->
            <div class="reviews-section modal-reviews-section">
                <div class="reviews-header">
                    <h4 class="reviews-title">Other Player Reviews</h4>
                    <span class="reviews-count" id="modal-reviews-count">Loading...</span>
                </div>
                <div class="reviews-list" id="modal-reviews-list">
                    <div class="reviews-loading">Loading reviews...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Game Modal -->
    <div id="report-game-modal" class="auth-overlay" style="display:none;">
        <div class="auth-panel" style="max-width:520px;">
            <div class="auth-header">
                <div class="auth-logo">
                    <span class="glitch" data-text="REPORT GAME">REPORT GAME</span>
                </div>
                <button class="auth-close" id="close-report-game">
                    <span class="close-icon">√ó</span>
                </button>
            </div>
            <div class="auth-content">
                <form id="report-game-form" class="neural-form">
                    <div style="margin-bottom:10px; opacity:0.85;">
                        Select a reason and provide optional details to help our moderators.
                    </div>
                    <fieldset class="input-container" style="border:none; padding:0; margin:0 0 10px 0;">
                        <div class="input-label">Reason</div>
                        <div class="input-line" style="display:none;"></div>
                        <div class="report-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="Bug / broken" required> <span>Bug / broken</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="Cheating / exploit"> <span>Cheating / exploit</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="Spam"> <span>Spam</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="Offensive / harassment"> <span>Offensive / harassment</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="NSFW / inappropriate"> <span>NSFW / inappropriate</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
                                <input type="radio" name="report-game-reason" value="Copyright / DMCA"> <span>Copyright / DMCA</span>
                            </label>
                            <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid var(--gray-700); background: rgba(255,255,255,0.03); cursor:pointer; user-select:none; grid-column: 1 / -1;">
                                <input type="radio" name="report-game-reason" value="Other"> <span>Other</span>
                            </label>
                        </div>
                    </fieldset>
                    <div class="input-container">
                        <div class="input-label">Details (optional)</div>
                        <textarea id="report-game-details" class="neural-input" rows="4" maxlength="500" placeholder="Add any helpful context (max 500 characters)"></textarea>
                        <div class="input-line"></div>
                    </div>
                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" class="neural-button secondary" id="cancel-report-game">
                            <span class="button-text">Cancel</span>
                        </button>
                        <button type="submit" class="neural-button primary" id="submit-report-game">
                            <span class="button-text">Submit Report</span>
                            <div class="button-glow"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Submission Modal -->
    <div id="edit-submission-modal" class="auth-overlay" style="display:none;">
        <div class="auth-panel" style="max-width:640px;">
            <div class="auth-header">
                <div class="auth-logo">
                    <span class="glitch" data-text="EDIT SUBMISSION">EDIT SUBMISSION</span>
                </div>
                <button class="auth-close" id="close-edit-submission"><span class="close-icon">√ó</span></button>
            </div>
            <div class="auth-content">
                <form id="edit-submission-form" class="neural-form">
                    <input type="hidden" id="edit-submission-id" />
                    <div class="input-container">
                        <div class="input-label">Title</div>
                        <input id="edit-title" class="neural-input" type="text" maxlength="120" placeholder="Enter game title" required />
                        <div class="input-line"></div>
                    </div>
                    <div class="input-container">
                        <div class="input-label">Description</div>
                        <textarea id="edit-description" class="neural-input" rows="5" maxlength="1000" placeholder="Describe your game (max 1000 characters)" required></textarea>
                        <div class="input-line"></div>
                    </div>
                    <div class="input-container">
                        <div class="input-label">Tags (max 3, comma-separated)</div>
                        <input id="edit-tags" class="neural-input" type="text" maxlength="120" placeholder="e.g. action, shooter, retro" />
                        <div class="input-line"></div>
                    </div>
                    <div class="input-container">
                        <div class="input-label">Badge</div>
                        <select id="edit-badge" class="neural-input">
                            <option value="">None</option>
                            <option value="new">NEW</option>
                            <option value="updated">UPDATED</option>
                            <option value="beta">BETA</option>
                        </select>
                        <div class="input-line"></div>
                    </div>
                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" class="neural-button secondary" id="cancel-edit-submission"><span class="button-text">Cancel</span></button>
                        <button type="submit" class="neural-button primary" id="save-edit-submission"><span class="button-text">Save Changes</span><div class="button-glow"></div></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/devicon@latest/devicon.min.js" defer></script>
    <script src="script.js" defer></script>

    <script>
        // Review System JavaScript
        let currentRating = 0;
        let currentGameId = '';
        let currentGameName = '';

        // Banned words for content filtering
        const bannedWords = [
            'spam', 'hate', 'stupid', 'dumb', 'sucks', 'terrible', 'worst', 'garbage',
            'trash', 'crap', 'shit', 'damn', 'hell', 'fuck', 'bitch', 'ass', 'dick',
            'idiot', 'moron', 'loser', 'noob', 'scrub', 'toxic', 'cancer', 'retard',
            'gay', 'fag', 'nigger', 'nazi', 'hitler', 'kill', 'die', 'suicide'
        ];

        // Suspicious words that require moderation
        const suspiciousWords = [
            'maybe', 'might', 'could be', 'not sure', 'uncertain', 'confusing',
            'hard to understand', 'complicated', 'difficult', 'boring', 'meh',
            'okay', 'average', 'mediocre', 'unsure', 'doubt', 'questionable'
        ];

        // Make functions globally available immediately
        window.openReviewModal = function(gameId, gameName) {
            currentGameId = gameId;
            currentGameName = gameName;
            
            document.getElementById('reviewGameName').textContent = gameName;
            document.getElementById('reviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            // Check if user is signed in
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                // Show reviews only mode - hide submission form
                hideSubmissionForm();
                updateModalTitle('REVIEWS - ' + gameName.toUpperCase());
            } else {
                // Show full review modal with submission form
                showSubmissionForm();
                updateModalTitle('LEAVE A REVIEW');
                resetReviewForm();
            }
            
            // Start realtime reviews for this game when modal opens
            try {
                if (typeof startLiveModalReviews === 'function') {
                    startLiveModalReviews(gameId);
                } else {
                    // Fallback to one-time load if live wiring isn't available yet
                    loadModalReviews(gameId);
                }
            } catch {
                // As an absolute fallback, keep previous behavior
                try { loadModalReviews(gameId); } catch {}
            }
        };

        window.closeReviewModal = function() {
            document.getElementById('reviewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetReviewForm();
            // Stop realtime listeners when modal closes
            try { if (typeof stopLiveModalReviews === 'function') stopLiveModalReviews(); } catch {}
        };

        function hideSubmissionForm() {
            // Hide review submission elements for non-logged in users
            const elementsToHide = [
                document.querySelector('.star-rating'),
                document.querySelector('.comment-section'),
                document.querySelector('.submit-section')
            ];
            
            elementsToHide.forEach(element => {
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Show login prompt
            showLoginPrompt();
        }

        function showSubmissionForm() {
            // Show review submission elements for logged in users
            const elementsToShow = [
                document.querySelector('.star-rating'),
                document.querySelector('.comment-section'),
                document.querySelector('.submit-section')
            ];
            
            elementsToShow.forEach(element => {
                if (element) {
                    element.style.display = 'block';
                }
            });
            
            // Hide login prompt
            hideLoginPrompt();
        }

        function updateModalTitle(title) {
            const titleElement = document.querySelector('.modal-title');
            if (titleElement) {
                titleElement.textContent = title;
            }
        }

        function showLoginPrompt() {
            const gameInfo = document.querySelector('.game-info');
            if (gameInfo) {
                gameInfo.innerHTML = `
                    <strong id="reviewGameName">${currentGameName}</strong>
                    <div class="login-prompt">
                        <p>Want to leave a review? <a href="#" class="login-link" onclick="triggerSignIn(event)">Sign in here</a></p>
                    </div>
                `;
            }
        }

        function hideLoginPrompt() {
            const gameInfo = document.querySelector('.game-info');
            if (gameInfo) {
                gameInfo.innerHTML = `<strong id="reviewGameName">${currentGameName}</strong>`;
            }
        }

        function triggerSignIn(event) {
            event.preventDefault(); // Prevent default link behavior
            
            // Close the review modal first
            closeReviewModal();
            
            // Try to trigger the header sign-in modal directly
            const signInModal = document.getElementById('signin-modal');
            if (signInModal) {
                signInModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Initialize Google button text based on active tab (from script.js)
                const googleButtonText = document.getElementById('google-button-text');
                const githubButtonText = document.getElementById('github-button-text');
                const activeTab = document.querySelector('.auth-tab.active');
                
                if (googleButtonText && activeTab) {
                    const tabType = activeTab.getAttribute('data-tab');
                    if (tabType === 'signin') {
                        googleButtonText.textContent = 'Sign in with Google';
                    } else if (tabType === 'signup') {
                        googleButtonText.textContent = 'Sign up with Google';
                    }
                }
                if (githubButtonText && activeTab) {
                    const tabType = activeTab.getAttribute('data-tab');
                    if (tabType === 'signin') {
                        githubButtonText.textContent = 'Sign in with GitHub';
                    } else if (tabType === 'signup') {
                        githubButtonText.textContent = 'Sign up with GitHub';
                    }
                }
            } else {
                // Fallback: try to click the header sign-in button
                const headerSignInBtn = document.getElementById('sign-in-btn');
                if (headerSignInBtn) {
                    headerSignInBtn.click();
                } else {
                    // Last resort fallback to direct navigation with redirect
                    try { sessionStorage.setItem('gr.returnTo', window.location.href); } catch {}
                    window.location.href = `Sign In/index.html?redirect=${encodeURIComponent(window.location.href)}`;
                }
            }
        }

        // Make function globally available
        window.triggerSignIn = triggerSignIn;

        window.closeSignInErrorModal = function() {
            const errorModal = document.getElementById('signInErrorModal');
            if (errorModal) {
                errorModal.style.display = 'none';
            }
            document.body.style.overflow = 'auto';
        };

        // Game Removed modal helpers
        window.openGameRemovedModal = function(gameName) {
            const modal = document.getElementById('gameRemovedModal');
            if (!modal) return;
            document.getElementById('removedGameName').textContent = gameName;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        };

        window.closeGameRemovedModal = function() {
            const modal = document.getElementById('gameRemovedModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Helper functions
        function showSignInError(gameName) {
            // Create or show sign-in error modal
            let errorModal = document.getElementById('signInErrorModal');
            if (!errorModal) {
                createSignInErrorModal();
                errorModal = document.getElementById('signInErrorModal');
            }
            
            document.getElementById('errorGameName').textContent = gameName;
            errorModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function createSignInErrorModal() {
            const modalHTML = `
                <div id="signInErrorModal" class="review-modal">
                    <div class="modal-content error-modal">
                        <span class="close-btn" onclick="closeSignInErrorModal()">&times;</span>
                        <h2 class="modal-title error-title">AUTHENTICATION REQUIRED</h2>
                        
                        <div class="error-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,16V18H13V16H11M11,6V14H13V6H11Z"/>
                            </svg>
                        </div>
                        
                        <div class="error-info">
                            <p class="error-message-text">You must be signed in to leave a review for <strong id="errorGameName">this game</strong>.</p>
                            <p class="error-sub-text">Please sign in to your GlitchRealm account to share your gaming experience with the community.</p>
                        </div>

                        <div class="submit-section">
                            <button class="btn cancel-btn" onclick="closeSignInErrorModal()">Close</button>
                            <button class="btn signin-btn" onclick="closeSignInErrorModal(); document.getElementById('auth-trigger').click();">Sign In</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function resetReviewForm() {
            currentRating = 0;
            updateStarDisplay();
            document.getElementById('reviewComment').value = '';
            updateCharCounter();
            document.getElementById('reviewMessage').innerHTML = '';
            document.getElementById('submitReview').disabled = false;
            document.getElementById('submitReview').innerHTML = 'Submit Review';
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const starElements = document.querySelectorAll('.star-half, .star-full, .star');
            
            starElements.forEach(star => {
                star.addEventListener('click', function() {
                    currentRating = parseFloat(this.dataset.rating);
                    updateStarDisplay();
                });

                star.addEventListener('mouseenter', function() {
                    const rating = parseFloat(this.dataset.rating);
                    highlightStars(rating);
                });
            });

            document.querySelector('.star-rating').addEventListener('mouseleave', function() {
                updateStarDisplay();
            });

            // Character counter
            document.getElementById('reviewComment').addEventListener('input', updateCharCounter);

            // Close modal on outside click
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('reviewModal');
                if (event.target === modal) {
                    closeReviewModal();
                }
            });

            // Load initial rating displays
            setTimeout(() => {
                updateAllRatingDisplays();
            }, 1000); // Wait for Firebase to initialize

            // After ratings init, load creator submissions onto the page
            /* loadPublishedGameSubmissions removed with modal extraction */
        });

        function updateStarDisplay() {
            highlightStars(currentRating);
        }

        function highlightStars(rating) {
            // Remove active class from all star elements
            const allStarElements = document.querySelectorAll('.star-half, .star-full, .star');
            allStarElements.forEach(star => {
                star.classList.remove('active');
            });

            // Add active class to appropriate stars based on rating
            allStarElements.forEach(star => {
                const starRating = parseFloat(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('active');
                }
            });

            // Legacy support for old star system
            const legacyStars = document.querySelectorAll('.star');
            legacyStars.forEach((star, index) => {
                if (index < Math.floor(rating)) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateCharCounter() {
            const textarea = document.getElementById('reviewComment');
            const counter = document.getElementById('charCounter');
            const length = textarea.value.length;
            
            counter.textContent = `${length}/500`;
            
            if (length > 450) {
                counter.classList.add('error');
                counter.classList.remove('warning');
            } else if (length > 400) {
                counter.classList.add('warning');
                counter.classList.remove('error');
            } else {
                counter.classList.remove('warning', 'error');
            }
        }

        // Advanced Content filtering with bypass detection
        function checkContent(text) {
            if (!text || text.trim() === '') {
                return { status: 'approved', reason: 'no comment provided' };
            }

            // Normalize text to catch variations and bypasses
            function normalizeText(input) {
                return input
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '') // Remove all special characters
                    .replace(/\s+/g, ' ') // Multiple spaces to single space
                    .replace(/(.)\1{2,}/g, '$1$1') // Reduce repeated characters (aaa -> aa)
                    .trim();
            }

            // Create variations of the text to catch bypasses - but exclude problematic vowel masking for legitimate words
            function createVariations(input) {
                const baseVariations = [
                    input.toLowerCase(),
                    normalizeText(input),
                    input.replace(/[*@#$%^&+=_\-~`|\\\/]/g, ''), // Remove common mask characters
                    input.replace(/[0-9]/g, (match) => { // Replace numbers with letters
                        const numMap = {'0': 'o', '1': 'i', '3': 'e', '4': 'a', '5': 's', '7': 't', '8': 'b'};
                        return numMap[match] || match;
                    }),
                    input.replace(/(.)/g, '$1 ').trim(), // Spaced out text
                    input.replace(/\s+/g, ''), // No spaces
                ];
                
                // Only add vowel masking and reverse for shorter suspicious text (likely actual bypass attempts)
                if (input.length < 20 && /[*@#$%^&+=_\-~`|\\\/]/.test(input)) {
                    baseVariations.push(input.replace(/[aeiou]/g, '*')); // Vowel masking detection
                    baseVariations.push(input.split('').reverse().join('')); // Reverse bypass attempts
                }
                
                return [...new Set(baseVariations)]; // Remove duplicates
            }

            // Enhanced banned words patterns with common bypasses - made more specific to avoid false positives
            const bannedPatterns = [
                // F-word variations - with word boundaries
                /\bf+[*@#$%^&+=_\-~`|\\\/\s]*[aeiou*@#$%^&+=_\-~`|\\\/\s]*c+[*@#$%^&+=_\-~`|\\\/\s]*k+\b/i,
                /\bf+[*@#$%^&+=_\-~`|\\\/\s]*[aeiou4*@#$%^&+=_\-~`|\\\/\s]*c+[*@#$%^&+=_\-~`|\\\/\s]*k+\b/i,
                /\bf+[u*@#$%^&+=_\-~`|\\\/\s]*c+[*@#$%^&+=_\-~`|\\\/\s]*k+\b/i,
                
                // S-word variations - with word boundaries
                /\bs+[*@#$%^&+=_\-~`|\\\/\s]*h+[*@#$%^&+=_\-~`|\\\/\s]*[i1*@#$%^&+=_\-~`|\\\/\s]*t+\b/i,
                /\bsh[*@#$%^&+=_\-~`|\\\/\s]*t\b/i,
                
                // B-word variations - with word boundaries
                /\bb+[*@#$%^&+=_\-~`|\\\/\s]*[i1*@#$%^&+=_\-~`|\\\/\s]*t+[*@#$%^&+=_\-~`|\\\/\s]*c+h+\b/i,
                /\bb[*@#$%^&+=_\-~`|\\\/\s]*tch\b/i,
                
                // A-word variations - more specific to avoid matching legitimate words
                /\bass+\b/i, // Only match "ass" as a standalone word
                /\ba+[*@#$%^&+=_\-~`|\\\/\s]*s+[*@#$%^&+=_\-~`|\\\/\s]*s+\b/i,
                
                // D-word variations - with word boundaries
                /\bd+[*@#$%^&+=_\-~`|\\\/\s]*[a4@*#$%^&+=_\-~`|\\\/\s]*m+n+\b/i,
                /\bd[*@#$%^&+=_\-~`|\\\/\s]*mn\b/i,
                
                // Hell variations - much more specific to avoid "bullets" -> "b*ll*ts"
                /\bhell+\b/i, // Only match "hell" as standalone
                /\bh+[*@#$%^&+=_\-~`|\\\/]*e+[*@#$%^&+=_\-~`|\\\/]*l+[*@#$%^&+=_\-~`|\\\/]*l+\b/i, // Must start with H and have double L
                
                // Other offensive terms with bypass patterns - all with word boundaries
                /\b[ck]+r+[*@#$%^&+=_\-~`|\\\/\s]*[a4@*#$%^&+=_\-~`|\\\/\s]*p+\b/i,
                /\bt+r+[*@#$%^&+=_\-~`|\\\/\s]*[a4@*#$%^&+=_\-~`|\\\/\s]*s+h+\b/i,
                /\bs+t+[*@#$%^&+=_\-~`|\\\/\s]*u+p+[*@#$%^&+=_\-~`|\\\/\s]*[i1*@#$%^&+=_\-~`|\\\/\s]*d+\b/i,
                /\bd+u+m+b+\b/i,
                /\b[i1*@#$%^&+=_\-~`|\\\/\s]*d+[i1*@#$%^&+=_\-~`|\\\/\s]*[o0*@#$%^&+=_\-~`|\\\/\s]*t+\b/i,
                /\bm+[o0*@#$%^&+=_\-~`|\\\/\s]*r+[o0*@#$%^&+=_\-~`|\\\/\s]*n+\b/i,
                /\bl+[o0*@#$%^&+=_\-~`|\\\/\s]*s+[e3*@#$%^&+=_\-~`|\\\/\s]*r+\b/i,
                /\bn+[o0*@#$%^&+=_\-~`|\\\/\s]*[o0*@#$%^&+=_\-~`|\\\/\s]*b+\b/i,
                /\bs+[ck]+r+u+b+\b/i,
                /\bt+[o0*@#$%^&+=_\-~`|\\\/\s]*x+[i1*@#$%^&+=_\-~`|\\\/\s]*[ck]+\b/i
            ];

            const textVariations = createVariations(text);
            
            // Check against regex patterns for bypasses
            for (let variation of textVariations) {
                for (let pattern of bannedPatterns) {
                    if (pattern.test(variation)) {
                        console.log(`üö´ Blocked bypass attempt: "${text}" -> detected pattern in variation: "${variation}"`);
                        return { status: 'blocked', reason: 'inappropriate content detected (bypass attempt)' };
                    }
                }
            }
            
            // Original banned words check (fallback) - with word boundaries to prevent false positives
            for (let variation of textVariations) {
                for (let word of bannedWords) {
                    // Use word boundaries to prevent false positives like "hell" in "bullets"
                    const wordPattern = new RegExp('\\b' + word.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                    if (wordPattern.test(variation)) {
                        console.log(`üö´ Blocked word: "${text}" -> contains: "${word}"`);
                        return { status: 'blocked', reason: 'inappropriate content detected' };
                    }
                }
            }
            
            // Check for suspicious content that needs moderation
            for (let variation of textVariations) {
                for (let word of suspiciousWords) {
                    if (variation.includes(word.toLowerCase())) {
                        console.log(`‚ö†Ô∏è  Flagged for review: "${text}" -> suspicious: "${word}"`);
                        return { status: 'pending', reason: 'content requires manual review' };
                    }
                }
            }
            
            console.log(`‚úÖ Content approved: "${text}"`);
            return { status: 'approved', reason: 'content approved automatically' };
        }

        function submitReview() {
            console.log('üîç submitReview() called');
            
            // Double-check authentication before submitting
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                console.log('‚ùå No authenticated user found');
                showMessage('‚ùå Error: You must be signed in to submit a review. Please sign in and try again.', 'error');
                closeReviewModal();
                showSignInError(currentGameName);
                return;
            }

            console.log('‚úÖ User authenticated:', window.firebaseAuth.currentUser.uid);

            if (currentRating === 0) {
                console.log('‚ùå No rating selected');
                showMessage('Please select a rating!', 'error');
                return;
            }

            console.log('‚úÖ Rating selected:', currentRating);

            const comment = document.getElementById('reviewComment').value.trim();
            const submitBtn = document.getElementById('submitReview');
            
            console.log('üìù Comment:', comment);
            console.log('üéÆ Game:', currentGameName, '(ID:', currentGameId + ')');
            
            // Show loading
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
            submitBtn.disabled = true;

            const contentCheck = checkContent(comment);
            console.log('üîç Content check result:', contentCheck);
            
            const authUser = window.firebaseAuth.currentUser;
            const derivedDisplayName = authUser.displayName || (authUser.email ? authUser.email.split('@')[0] : 'Anonymous User');
            const derivedPhoto = authUser.photoURL || 'assets/icons/anonymous.png';
            // Firestore rules require: rating int 1-5, timestamp is timestamp (use serverTimestamp), moderationStatus value in list
            // We'll map blocked -> 'blocked', pending->'pending', approved->'approved'.
            const normalizedStatus = (contentCheck.status === 'blocked') ? 'blocked' : (contentCheck.status === 'pending' ? 'pending' : 'approved');
            const review = {
                gameId: currentGameId,
                gameName: currentGameName.substring(0,100),
                rating: Math.min(5, Math.max(1, Math.round(currentRating))),
                comment: comment.substring(0,500),
                moderationStatus: normalizedStatus,
                timestamp: window.firestoreServerTimestamp ? window.firestoreServerTimestamp() : new Date(),
                userId: authUser.uid,
                userDisplayName: derivedDisplayName.substring(0,50),
                authorPhotoUrl: derivedPhoto.substring(0,2000),
                reason: contentCheck.reason.substring(0,200)
            };

            console.log('üìã Review object created:', review);

            // Check for blocked content before attempting to submit
            if (contentCheck.status === 'blocked') {
                console.log('üö´ Content blocked - not submitting to Firestore');
                showMessage('‚ùå Your review contains inappropriate content and cannot be submitted. Please revise your comment and try again.', 'error');
                submitBtn.innerHTML = 'Submit Review';
                submitBtn.disabled = false;
                return;
            }

            console.log('üöÄ Attempting to submit to Firestore...');

            // Submit to Firestore using the same method that worked for test review
            window.firestoreAddDoc(window.firestoreCollection(window.firebaseFirestore, 'reviews'), review)
                .then(async (docRef) => {
                    console.log('‚úÖ SUCCESS! Review written with ID: ', docRef.id);
                    console.log('üîó Document reference:', docRef);
                    console.log('üìä Check Firebase Console - review should be in reviews collection!');
                    
                    // Also save to localStorage for demo purposes
                    saveReview({...review, id: docRef.id});

                    // Reset button state
                    submitBtn.innerHTML = 'Submit Review';
                    submitBtn.disabled = false;

                    // Show appropriate message based on content check
                    if (contentCheck.status === 'pending') {
                        showMessage('‚è≥ Your review has been submitted and is pending moderation. It will be visible once approved by our team.', 'warning');
                        // Update rating display after a short delay
                        setTimeout(async () => {
                            const ratingData = await calculateAverageRating(currentGameId);
                            updateRatingDisplay(currentGameId, ratingData);
                        }, 500);
                        setTimeout(() => closeReviewModal(), 3000);
                    } else {
                        showMessage('‚úÖ Your review has been submitted successfully and is now live!', 'success');
                        // Refresh the reviews display in the modal
                        refreshModalReviews();
                        // Update the rating display for this game
                        setTimeout(async () => {
                            const ratingData = await calculateAverageRating(currentGameId);
                            updateRatingDisplay(currentGameId, ratingData);
                        }, 500);
                        setTimeout(() => closeReviewModal(), 2000);
                    }
                })
                .catch((error) => {
                    console.error('‚ùå FIRESTORE ERROR:', error);
                    console.log('Full error details:', error.message);
                    showMessage('‚ùå Error submitting review: ' + error.message, 'error');
                    submitBtn.innerHTML = 'Submit Review';
                    submitBtn.disabled = false;
                });
        }

        function saveReview(review) {
            let reviews = JSON.parse(localStorage.getItem('gameReviews')) || [];
            reviews.push(review);
            localStorage.setItem('gameReviews', JSON.stringify(reviews));
            
            // Also log review stats
            console.log(`Total reviews saved: ${reviews.length}`);
            console.log(`Reviews for ${review.gameName}: ${reviews.filter(r => r.gameId === review.gameId).length}`);
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('reviewMessage');
            messageDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        // Function to view stored reviews (for testing)
        function viewStoredReviews() {
            const reviews = JSON.parse(localStorage.getItem('gameReviews')) || [];
            console.log('All stored reviews:', reviews);
            return reviews;
        }

        // Function to clear all reviews (for testing)
        function clearAllReviews() {
            localStorage.removeItem('gameReviews');
            console.log('All reviews cleared!');
        }

        // Function to calculate average rating for a game
        async function calculateAverageRating(gameId) {
            try {
                if (!window.firebaseFirestore || !window.firestoreCollection || !window.firestoreQuery) {
                    console.log('Firebase not available, checking localStorage...');
                    return calculateLocalAverageRating(gameId);
                }

                const reviewsRef = window.firestoreCollection(window.firebaseFirestore, 'reviews');
                const q = window.firestoreQuery(
                    reviewsRef,
                    window.firestoreWhere('gameId', '==', gameId),
                    window.firestoreWhere('moderationStatus', '==', 'approved')
                );
                
                const querySnapshot = await window.firestoreGetDocs(q);
                const reviews = [];
                
                querySnapshot.forEach((doc) => {
                    reviews.push(doc.data());
                });
                
                if (reviews.length === 0) {
                    return { average: 0, count: 0 };
                }
                
                const totalRating = reviews.reduce((sum, review) => sum + (review.rating || 0), 0);
                const average = Math.round((totalRating / reviews.length) * 10) / 10; // Round to 1 decimal
                
                return { average, count: reviews.length };
                
            } catch (error) {
                console.log('Error calculating average rating from Firestore, falling back to localStorage:', error);
                return calculateLocalAverageRating(gameId);
            }
        }

        // Fallback function for localStorage
        function calculateLocalAverageRating(gameId) {
            const reviews = JSON.parse(localStorage.getItem('gameReviews')) || [];
            const gameReviews = reviews.filter(review => 
                review.gameId === gameId && 
                (review.moderationStatus === 'approved' || !review.moderationStatus)
            );
            
            if (gameReviews.length === 0) {
                return { average: 0, count: 0 };
            }
            
            const totalRating = gameReviews.reduce((sum, review) => sum + (review.rating || 0), 0);
            const average = Math.round((totalRating / gameReviews.length) * 10) / 10;
            
            return { average, count: gameReviews.length };
        }

        // Function to update rating displays for all games
        async function updateAllRatingDisplays() {
            // Find all rating-display elements and update them dynamically
            const ratingNodes = Array.from(document.querySelectorAll('.rating-display[data-game-id]'));
            const uniqueIds = [...new Set(ratingNodes.map(n => n.getAttribute('data-game-id')))]
                .filter(Boolean);
            for (const gameId of uniqueIds) {
                try {
                    const ratingData = await calculateAverageRating(gameId);
                    updateRatingDisplay(gameId, ratingData);
                } catch (e) {
                    console.warn('Failed to update rating for', gameId, e);
                }
            }
        }

        // Function to update rating display for a specific game
        function updateRatingDisplay(gameId, ratingData) {
            const ratingElement = document.querySelector(`[data-game-id="${gameId}"]`);
            
            if (ratingElement) {
                if (ratingData.count > 0) {
                    ratingElement.innerHTML = `<span class="avg-rating">${ratingData.average}‚≠ê (${ratingData.count})</span>`;
                } else {
                    ratingElement.innerHTML = `<span class="no-rating">N/A (0)</span>`;
                }
            }
        }

        // Make functions available globally for testing
        window.viewStoredReviews = viewStoredReviews;
        window.clearAllReviews = clearAllReviews;
        window.calculateAverageRating = calculateAverageRating;
        window.updateAllRatingDisplays = updateAllRatingDisplays;
        
        // Make review functions globally accessible
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.closeSignInErrorModal = closeSignInErrorModal;
        window.submitReview = submitReview;

        // Game Options Modal Functions
        let currentGameOptions = {
            gameId: '',
            gameName: '',
            localPath: '',
            externalUrl: ''
        };

        window.showGameOptionsModal = function(gameId, gameName, localPath, externalUrl) {
            // Check if user has a remembered preference
            const rememberedChoice = localStorage.getItem('gamePlayPreference');
            if (rememberedChoice) {
                if (rememberedChoice === 'local') {
                    window.location.href = localPath;
                    return;
                } else if (rememberedChoice === 'external') {
                    window.open(externalUrl, '_blank');
                    return;
                }
            }
            
            currentGameOptions = { gameId, gameName, localPath, externalUrl };
            
            document.getElementById('gameOptionsTitle').textContent = gameName;
            document.getElementById('gameOptionsModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Reset checkbox
            document.getElementById('rememberChoice').checked = false;
            
            // Set up button click handlers
            document.getElementById('localGameBtn').onclick = function() {
                const rememberChoice = document.getElementById('rememberChoice').checked;
                if (rememberChoice) {
                    localStorage.setItem('gamePlayPreference', 'local');
                }
                window.location.href = localPath;
            };
            
            document.getElementById('externalGameBtn').onclick = function() {
                const rememberChoice = document.getElementById('rememberChoice').checked;
                if (rememberChoice) {
                    localStorage.setItem('gamePlayPreference', 'external');
                }
                window.open(externalUrl, '_blank');
                closeGameOptionsModal();
            };
        };

        window.closeGameOptionsModal = function() {
            document.getElementById('gameOptionsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Function to clear remembered preference (for testing/resetting)
        window.clearGamePreference = function() {
            localStorage.removeItem('gamePlayPreference');
            console.log('Game preference cleared!');
        };

        // Close modal on outside click
        document.addEventListener('click', function(event) {
            const gameOptionsModal = document.getElementById('gameOptionsModal');
            if (event.target === gameOptionsModal) {
                closeGameOptionsModal();
            }
        });

        // Reviews Display Functions for Modal
        // Realtime state for modal reviews (approved + pending for privileged users) and their replies
        let __modalReviews = {
            active: false,
            gameId: null,
            isPrivileged: false,
            unsubApproved: null,
            unsubPending: null,
            unsubReplies: null,
            approvedMap: new Map(),    // id -> review
            pendingMap: new Map(),     // id -> review (privileged only)
            repliesMap: new Map(),     // id -> [replies]
            renderTimer: null
        };

        function clearModalReviewsUI() {
            const countElement = document.getElementById('modal-reviews-count');
            const listElement = document.getElementById('modal-reviews-list');
            if (countElement) countElement.textContent = '0 Reviews';
            if (listElement) listElement.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to leave a review!</div>';
        }

        function showLoadingModalReviewsUI() {
            const countElement = document.getElementById('modal-reviews-count');
            const listElement = document.getElementById('modal-reviews-list');
            if (countElement) countElement.textContent = 'Loading...';
            if (listElement) listElement.innerHTML = '<div class="reviews-loading">Loading reviews...</div>';
        }

        function computePrivilege() {
            const isAuthed = !!(window.firebaseAuth && window.firebaseAuth.currentUser);
            const currentUid = isAuthed ? window.firebaseAuth.currentUser.uid : null;
            const developerUIDs = [
                '6iZDTXC78aVwX22qrY43BOxDRLt1',
                'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
                'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
            ];
            const adminUIDs = [
                'admin-uid-1',
                'admin-uid-2',
                'replace-with-your-admin-uid'
            ];
            return !!(currentUid && (developerUIDs.includes(currentUid) || adminUIDs.includes(currentUid)));
        }

        function scheduleModalReviewsRender() {
            if (__modalReviews.renderTimer) {
                clearTimeout(__modalReviews.renderTimer);
            }
            __modalReviews.renderTimer = setTimeout(() => {
                try {
                    const all = [];
                    // Merge maps
                    __modalReviews.approvedMap.forEach((val, key) => all.push(val));
                    if (__modalReviews.isPrivileged) {
                        __modalReviews.pendingMap.forEach((val, key) => all.push(val));
                    }
                    // Attach replies
                    const reviews = all.map(r => ({
                        ...r,
                        replies: __modalReviews.repliesMap.get(r.id) || []
                    }));
                    // Sort by timestamp desc
                    reviews.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                    displayModalReviews(reviews);
                    // Keep rating display in sync while modal is open
                    if (typeof calculateAverageRating === 'function' && typeof updateRatingDisplay === 'function' && __modalReviews.gameId) {
                        calculateAverageRating(__modalReviews.gameId).then(data => updateRatingDisplay(__modalReviews.gameId, data)).catch(()=>{});
                    }
                } catch (e) {
                    console.error('[reviews modal] render failed:', e);
                }
            }, 80);
        }

        async function attachRepliesListener(reviewIds) {
            try {
                if (__modalReviews.unsubReplies) { try { __modalReviews.unsubReplies(); } catch {} __modalReviews.unsubReplies = null; }
                __modalReviews.repliesMap = new Map();
                if (!reviewIds || reviewIds.length === 0) {
                    scheduleModalReviewsRender();
                    return;
                }
                // Firestore 'in' supports up to 10 ids; we limit reviews to 10 so this is safe
                const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const repliesRef = window.firestoreCollection(window.firebaseFirestore, 'review_replies');
                const q = f.query(
                    repliesRef,
                    f.where('reviewId', 'in', reviewIds),
                    f.orderBy('timestamp', 'asc')
                );
                __modalReviews.unsubReplies = f.onSnapshot(q, (snap) => {
                    try {
                        const tmp = new Map();
                        snap.forEach(d => {
                            const reply = { id: d.id, ...d.data() };
                            const arr = tmp.get(reply.reviewId) || [];
                            arr.push(reply);
                            tmp.set(reply.reviewId, arr);
                        });
                        __modalReviews.repliesMap = tmp;
                        scheduleModalReviewsRender();
                    } catch (e) { console.error('[reviews modal] replies snapshot err:', e); }
                }, (err) => {
                    console.error('[reviews modal] replies realtime error:', err);
                });
            } catch (e) {
                console.error('[reviews modal] failed to attach replies listener:', e);
            }
        }

        async function startLiveModalReviews(gameId) {
            try {
                // Stop any existing listeners first
                try { stopLiveModalReviews(); } catch {}
                __modalReviews.active = true;
                __modalReviews.gameId = gameId;
                __modalReviews.isPrivileged = computePrivilege();
                __modalReviews.approvedMap = new Map();
                __modalReviews.pendingMap = new Map();
                __modalReviews.repliesMap = new Map();
                showLoadingModalReviewsUI();

                const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const reviewsRef = window.firestoreCollection(window.firebaseFirestore, 'reviews');

                // Common helper to normalize timestamp to millis for UI sorting/formatting
                function toMillis(ts) {
                    if (!ts) return 0;
                    if (typeof ts === 'number') return ts;
                    if (typeof ts === 'string') { const t = Date.parse(ts); return isNaN(t) ? 0 : t; }
                    if (typeof ts.toMillis === 'function') return ts.toMillis();
                    try { return new Date(ts).getTime() || 0; } catch { return 0; }
                }

                const approvedQ = f.query(
                    reviewsRef,
                    f.where('gameId', '==', gameId),
                    f.where('moderationStatus', '==', 'approved'),
                    f.orderBy('timestamp', 'desc'),
                    f.limit(10)
                );
                __modalReviews.unsubApproved = f.onSnapshot(approvedQ, (snap) => {
                    try {
                        const ids = [];
                        const map = new Map();
                        snap.forEach(d => {
                            const data = d.data();
                            const norm = { id: d.id, ...data, timestamp: toMillis(data.timestamp) };
                            map.set(d.id, norm);
                            ids.push(d.id);
                        });
                        __modalReviews.approvedMap = map;
                        // Update replies listener with current set of reviewIds across both sets
                        const pendingIds = Array.from(__modalReviews.pendingMap.keys());
                        const combined = [...new Set([...ids, ...pendingIds])];
                        attachRepliesListener(combined);
                        scheduleModalReviewsRender();
                    } catch (e) { console.error('[reviews modal] approved snapshot err:', e); }
                }, (err) => {
                    console.error('[reviews modal] approved realtime error:', err);
                    clearModalReviewsUI();
                });

                if (__modalReviews.isPrivileged) {
                    const pendingQ = f.query(
                        reviewsRef,
                        f.where('gameId', '==', gameId),
                        f.where('moderationStatus', '==', 'pending'),
                        f.orderBy('timestamp', 'desc'),
                        f.limit(10)
                    );
                    __modalReviews.unsubPending = f.onSnapshot(pendingQ, (snap) => {
                        try {
                            const ids = [];
                            const map = new Map();
                            snap.forEach(d => {
                                const data = d.data();
                                const norm = { id: d.id, ...data, timestamp: toMillis(data.timestamp) };
                                map.set(d.id, norm);
                                ids.push(d.id);
                            });
                            __modalReviews.pendingMap = map;
                            const approvedIds = Array.from(__modalReviews.approvedMap.keys());
                            const combined = [...new Set([...ids, ...approvedIds])];
                            attachRepliesListener(combined);
                            scheduleModalReviewsRender();
                        } catch (e) { console.error('[reviews modal] pending snapshot err:', e); }
                    }, (err) => {
                        console.error('[reviews modal] pending realtime error:', err);
                    });
                }
            } catch (error) {
                console.error('[reviews modal] failed to start live listeners:', error);
                // Fallback to single load
                try { await loadModalReviews(gameId); } catch {}
            }
        }

        function stopLiveModalReviews() {
            try { if (__modalReviews.unsubApproved) { __modalReviews.unsubApproved(); } } catch {}
            try { if (__modalReviews.unsubPending) { __modalReviews.unsubPending(); } } catch {}
            try { if (__modalReviews.unsubReplies) { __modalReviews.unsubReplies(); } } catch {}
            __modalReviews.unsubApproved = null;
            __modalReviews.unsubPending = null;
            __modalReviews.unsubReplies = null;
            __modalReviews.active = false;
            __modalReviews.gameId = null;
            __modalReviews.approvedMap = new Map();
            __modalReviews.pendingMap = new Map();
            __modalReviews.repliesMap = new Map();
            if (__modalReviews.renderTimer) { try { clearTimeout(__modalReviews.renderTimer); } catch {} __modalReviews.renderTimer = null; }
        }
        async function loadModalReviews(gameId) {
            try {
                console.log(`üîç Loading reviews for game in modal: ${gameId}`);
                
                // Reset modal reviews display
                const countElement = document.getElementById('modal-reviews-count');
                const listElement = document.getElementById('modal-reviews-list');
                
                if (countElement) countElement.textContent = 'Loading...';
                if (listElement) listElement.innerHTML = '<div class="reviews-loading">Loading reviews...</div>';
                
                // Import query functions
                const { query, where, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Build query: by default only approved reviews. If current user is a developer/admin, include pending too.
                const reviewsRef = window.firestoreCollection(window.firebaseFirestore, 'reviews');
                const isAuthed = !!(window.firebaseAuth && window.firebaseAuth.currentUser);
                const currentUid = isAuthed ? window.firebaseAuth.currentUser.uid : null;
                const developerUIDs = [
                    '6iZDTXC78aVwX22qrY43BOxDRLt1',
                    'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
                    'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                    '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                    'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
                ];
                const adminUIDs = [
                    'admin-uid-1',
                    'admin-uid-2',
                    'replace-with-your-admin-uid'
                ];
                const isPrivileged = currentUid && (developerUIDs.includes(currentUid) || adminUIDs.includes(currentUid));

                // Note: Firestore doesn't support 'in' on same field with orderBy easily; we fetch approved first,
                // and if privileged, we also fetch pending and merge. This avoids composite index issues.
                const baseQuery = query(
                    reviewsRef,
                    where('gameId', '==', gameId),
                    where('moderationStatus', '==', 'approved'),
                    orderBy('timestamp', 'desc'),
                    limit(10)
                );
                let querySnapshots = [await getDocs(baseQuery)];
                if (isPrivileged) {
                    const pendingQuery = query(
                        reviewsRef,
                        where('gameId', '==', gameId),
                        where('moderationStatus', '==', 'pending'),
                        orderBy('timestamp', 'desc'),
                        limit(10)
                    );
                    querySnapshots.push(await getDocs(pendingQuery));
                }
                
                const reviews = [];
                for (const qs of querySnapshots) {
                    qs.forEach((doc) => {
                        reviews.push({ id: doc.id, ...doc.data() });
                    });
                }
                
                // Load replies for all reviews
                const reviewsWithReplies = await loadRepliesForReviews(reviews);
                
                console.log(`‚úÖ Loaded ${reviewsWithReplies.length} reviews for ${gameId} in modal`);
                displayModalReviews(reviewsWithReplies);
                
            } catch (error) {
                console.error(`‚ùå Error loading reviews for ${gameId} in modal:`, error);
                
                // Check if it's a permission error and Firebase isn't available
                if (error.message.includes('Missing or insufficient permissions') || 
                    error.code === 'permission-denied' ||
                    !window.firebaseFirestore || 
                    !window.firestoreCollection) {
                    
                    console.log('üîí Permission denied or Firebase unavailable, showing placeholder');
                    const countElement = document.getElementById('modal-reviews-count');
                    const listElement = document.getElementById('modal-reviews-list');
                    
                    if (countElement) countElement.textContent = '0 Reviews';
                    if (listElement) {
                        listElement.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to leave a review!</div>';
                    }
                } else {
                    displayModalReviewsError(error.message);
                }
            }
        }

        async function loadRepliesForReviews(reviews) {
            try {
                // Import query functions
                const { query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Get all review IDs
                const reviewIds = reviews.map(review => review.id);
                
                if (reviewIds.length === 0) {
                    return reviews;
                }
                
                // Query all replies for these reviews
                const repliesRef = window.firestoreCollection(window.firebaseFirestore, 'review_replies');
                const repliesQuery = query(
                    repliesRef,
                    where('reviewId', 'in', reviewIds),
                    orderBy('timestamp', 'asc')
                );
                
                const repliesSnapshot = await getDocs(repliesQuery);
                const repliesMap = {};
                
                repliesSnapshot.forEach((doc) => {
                    const reply = { id: doc.id, ...doc.data() };
                    if (!repliesMap[reply.reviewId]) {
                        repliesMap[reply.reviewId] = [];
                    }
                    repliesMap[reply.reviewId].push(reply);
                });
                
                // Add replies to reviews
                const reviewsWithReplies = reviews.map(review => ({
                    ...review,
                    replies: repliesMap[review.id] || []
                }));
                
                console.log(`üì® Loaded replies for ${Object.keys(repliesMap).length} reviews`);
                return reviewsWithReplies;
                
            } catch (error) {
                console.error('‚ùå Error loading replies:', error);
                return reviews; // Return reviews without replies if loading fails
            }
        }

        function displayModalReviews(reviews) {
            const countElement = document.getElementById('modal-reviews-count');
            const listElement = document.getElementById('modal-reviews-list');
            
            if (!countElement || !listElement) {
                console.warn('Modal review elements not found');
                return;
            }
            
            // Update count
            countElement.textContent = `${reviews.length} review${reviews.length !== 1 ? 's' : ''}`;
            
            // Clear loading state
            listElement.innerHTML = '';
            
            if (reviews.length === 0) {
                listElement.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to review this game!</div>';
                return;
            }
            
            // Display reviews
            reviews.forEach(review => {
                const reviewElement = createReviewElement(review);
                listElement.appendChild(reviewElement);
            });
        }

        function displayModalReviewsError(errorMessage) {
            const countElement = document.getElementById('modal-reviews-count');
            const listElement = document.getElementById('modal-reviews-list');
            
            if (countElement) countElement.textContent = 'Error loading';
            if (listElement) {
                listElement.innerHTML = `<div class="reviews-empty">Error loading reviews: ${errorMessage}</div>`;
            }
        }

        // Helper function to generate star display with half-star support
        function generateStarsDisplay(rating) {
            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            const emptyStars = 5 - Math.ceil(rating);
            
            // Add full stars
            starsHTML += '‚≠ê'.repeat(fullStars);
            
            // Add half star if needed
            if (hasHalfStar) {
                starsHTML += '‚≠ê'; // Using full star for display simplicity, but showing the decimal in text
            }
            
            // Add empty stars
            starsHTML += '‚òÜ'.repeat(emptyStars);
            
            return starsHTML;
        }

        function createReviewElement(review) {
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-item';
            
            // Create stars display with half-star support
            const stars = generateStarsDisplay(review.rating);
            
            // Format date
            const reviewDate = new Date(review.timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Special user UIDs
            const developerUIDs = [
                '6iZDTXC78aVwX22qrY43BOxDRLt1',
                'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
                'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
            ];
            
            const artistUIDs = [
                'yFtl1s7jOeSAL78yJPORchAgjE93',
                'cuGtyQvqilcWmxS859eta41Plak2'
            ];
            
            // Check for special badges
            let userBadge = '';
            if (developerUIDs.includes(review.userId)) {
                userBadge = '<span class="user-badge developer-badge"><i class="devicon-javascript-plain"></i> DEVELOPER</span>';
            } else if (artistUIDs.includes(review.userId)) {
                userBadge = '<span class="user-badge artist-badge"><i class="devicon-photoshop-plain"></i> ARTIST</span>';
            }
            
            // Moderation badge
            const moderationBadge = review.moderationStatus === 'pending' 
                ? '<span class="review-moderation review-pending">Pending</span>'
                : '<span class="review-moderation review-approved">Approved</span>';
            
            // Generate replies HTML
            const repliesHTML = generateRepliesHTML(review.replies || []);
            
            // Reviewer identity: resolve display name similarly to updateUserProfile logic.
            const reviewerId = typeof review.userId === 'string' ? review.userId : 'unknown';
            const baseFallback = review.userDisplayName || (reviewerId === 'unknown' ? 'Anonymous User' : (reviewerId.length > 10 ? reviewerId.slice(0,6) + '...' + reviewerId.slice(-4) : reviewerId));
            // Placeholder span we'll fill asynchronously if we can fetch user profile.
            const identityId = `rev-ident-${review.id}`;
            const identityHTML = `<span class="review-author" id="${identityId}" title="User ID: ${reviewerId}"><strong>${escapeHtml(baseFallback)}</strong></span>`;

            // Initial avatar placeholder (will attempt to fetch from users/{uid} profile or fallback)
            const avatarId = `rev-av-${review.id}`;
            const verifiedBadgeId = `rev-ver-${review.id}`;
            reviewDiv.innerHTML = `
                <div class="review-header">
                    <div class="review-avatar-wrap">
                        <img id="${avatarId}" class="review-avatar" src="${escapeHtml(review.authorPhotoUrl || 'assets/icons/anonymous.png')}" alt="User Avatar" loading="lazy" decoding="async" />
                    </div>
                    <div class="review-body">
                        <div class="review-meta-line">
                            <div class="review-badges">
                                ${identityHTML}
                                <span id="${verifiedBadgeId}" style="display:none" class="review-verification" title="Verified Creator" aria-label="Verified">
                                    <svg viewBox="0 0 24 24"><path d="M12 2l2.9 2.1 3.5-.3 1.1 3.3 3 1.8-1.2 3.3 1.2 3.3-3 1.8-1.1 3.3-3.5-.3L12 22l-2.9-2.1-3.5.3-1.1-3.3-3-1.8L2.7 12 1.5 8.7l3-1.8 1.1-3.3 3.5.3L12 2zm-1.2 13.6l6-6-1.4-1.4-4.6 4.6-2.2-2.2-1.4 1.4 3.6 3.6z"/></svg>
                                </span>
                                ${userBadge}
                                ${moderationBadge}
                            </div>
                            <div class="review-rating">${stars} <small>${review.rating}/5</small></div>
                            <span class="review-date">${reviewDate}</span>
                        </div>
                        <p class="review-comment">${escapeHtml(review.comment || 'No comment provided.')}</p>
                        ${repliesHTML}
                        ${getDeveloperReplyButton(review.id)}
                    </div>
                </div>
            `;
            
            // Attempt to enrich with live user displayName (one fetch per unique UID cached in memory)
            try {
                if (!window.__grUserCache) window.__grUserCache = new Map();
                const cache = window.__grUserCache;
                if (reviewerId !== 'unknown') {
                    if (cache.has(reviewerId)) {
                        const name = cache.get(reviewerId);
                        const el = reviewDiv.querySelector('#' + identityId + ' strong');
                        if (el && name) el.textContent = name;
                    } else if (window.firebaseAuth) {
                        // Use Auth reload pattern only for current user; for others attempt Firestore profile doc if exists
                        (async () => {
                            try {
                                const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                const db = f.getFirestore();
                                // Assume optional profile doc at users/{uid}
                                const docRef = f.doc(db, 'users', reviewerId);
                                const snap = await f.getDoc(docRef);
                                let name = null;
                                let photo = null;
                                if (snap.exists() && typeof snap.data().displayName === 'string') {
                                    name = snap.data().displayName;
                                } else {
                                    // Fallback: email prefix if stored
                                    if (snap.exists() && typeof snap.data().email === 'string') {
                                        name = snap.data().displayName || snap.data().email.split('@')[0];
                                    }
                                }
                                if (snap.exists() && typeof snap.data().photoURL === 'string') {
                                    photo = snap.data().photoURL;
                                }
                                // Check verified flag in separate verified_users collection
                                try {
                                    const verifiedSnap = await f.getDoc(f.doc(db, 'verified_users', reviewerId));
                                    if (verifiedSnap.exists() && verifiedSnap.data().verified === true) {
                                        const vb = reviewDiv.querySelector('#' + verifiedBadgeId);
                                        if (vb) vb.style.display = 'inline-flex';
                                    }
                                } catch {}
                                if (!name && reviewerId === window.firebaseAuth.currentUser?.uid) {
                                    const u = window.firebaseAuth.currentUser;
                                    name = u.displayName || (u.email ? u.email.split('@')[0] : null);
                                    if (u && u.photoURL) photo = u.photoURL;
                                }
                                if (name) {
                                    cache.set(reviewerId, name);
                                    const el = reviewDiv.querySelector('#' + identityId + ' strong');
                                    if (el) el.textContent = name;
                                }
                                if (photo) {
                                    const av = reviewDiv.querySelector('#' + avatarId);
                                    if (av) av.src = photo;
                                }
                            } catch (e) { /* silent */ }
                        })();
                    }
                }
            } catch {}

            return reviewDiv;
        }

        function generateRepliesHTML(replies) {
            if (!replies || replies.length === 0) {
                return '';
            }
            
            const developerUIDs = [
                '6iZDTXC78aVwX22qrY43BOxDRLt1',
                'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
                'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
            ];
            
            let repliesHTML = '<div class="review-replies">';
            
            replies.forEach(reply => {
                const replyDate = new Date(reply.timestamp).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const isDeveloper = developerUIDs.includes(reply.userId);
                const replyBadge = isDeveloper 
                    ? '<span class="user-badge developer-badge"><i class="devicon-javascript-plain"></i> DEVELOPER</span>'
                    : '';
                
                repliesHTML += `
                    <div class="developer-reply">
                        <div class="reply-header">
                            <div class="reply-author">
                                <i class="devicon-javascript-plain"></i>
                                Developer Reply
                                ${replyBadge}
                            </div>
                            <span class="reply-date">${replyDate}</span>
                        </div>
                        <p class="reply-text">${escapeHtml(reply.replyText)}</p>
                    </div>
                `;
            });
            
            repliesHTML += '</div>';
            return repliesHTML;
        }

        function getDeveloperReplyButton(reviewId) {
            // Check if current user is a developer
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                return '';
            }
            
            const currentUserId = window.firebaseAuth.currentUser.uid;
            const developerUIDs = [
                '6iZDTXC78aVwX22qrY43BOxDRLt1',
                'YR3c4TBw09aK7yYxd7vo0AmI6iG3', 
                'g14MPDZzUzR9ELP7TD6IZgk3nzx2',
                '4oGjihtDjRPYI0LsTDhpXaQAJjk1',
                'ZEkqLM6rNTZv1Sun0QWcKYOIbon1'
            ];
            
            if (developerUIDs.includes(currentUserId)) {
                return `
                    <div class="developer-reply-section">
                        <button class="developer-reply-btn" onclick="showDeveloperReply('${reviewId}')">
                            <i class="devicon-javascript-plain"></i> Developer Reply
                        </button>
                        <div class="developer-reply-form" id="reply-form-${reviewId}" style="display: none;">
                            <textarea 
                                class="developer-reply-textarea" 
                                id="reply-text-${reviewId}" 
                                placeholder="Reply as developer..."
                                maxlength="300"></textarea>
                            <div class="developer-reply-actions">
                                <button class="btn-small cancel-reply" onclick="hideDeveloperReply('${reviewId}')">Cancel</button>
                                <button class="btn-small submit-reply" onclick="submitDeveloperReply('${reviewId}')">Post Reply</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Refresh modal reviews after successful submission
        function refreshModalReviews() {
            // With realtime listeners, manual refresh is unnecessary
            if (__modalReviews && __modalReviews.active) {
                console.log(`üîÑ Realtime active for ${currentGameId}; no manual refresh needed`);
                return;
            }
            console.log(`üîÑ Refreshing reviews for ${currentGameId} in modal (fallback one-time load)`);
            setTimeout(() => {
                try { loadModalReviews(currentGameId); } catch {}
            }, 800);
        }

        // Make functions globally available
        window.refreshModalReviews = refreshModalReviews;

        // Developer Reply Functions
        function showDeveloperReply(reviewId) {
            const replyForm = document.getElementById(`reply-form-${reviewId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
                const textarea = document.getElementById(`reply-text-${reviewId}`);
                if (textarea) {
                    textarea.focus();
                }
            }
        }

        function hideDeveloperReply(reviewId) {
            const replyForm = document.getElementById(`reply-form-${reviewId}`);
            if (replyForm) {
                replyForm.style.display = 'none';
                const textarea = document.getElementById(`reply-text-${reviewId}`);
                if (textarea) {
                    textarea.value = '';
                }
            }
        }

        async function submitDeveloperReply(reviewId) {
            const textarea = document.getElementById(`reply-text-${reviewId}`);
            const replyText = textarea ? textarea.value.trim() : '';
            
            if (!replyText) {
                alert('Please enter a reply message.');
                return;
            }

            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                alert('You must be signed in to reply.');
                return;
            }

            try {
                console.log(`üîß Developer replying to review ${reviewId}:`, replyText);
                
                // Create reply object
                const reply = {
                    reviewId: reviewId,
                    replyText: replyText,
                    userId: window.firebaseAuth.currentUser.uid,
                    timestamp: new Date().toISOString(),
                    type: 'developer_reply'
                };

                // Save to Firestore
                await window.firestoreAddDoc(window.firestoreCollection(window.firebaseFirestore, 'review_replies'), reply);
                
                console.log('‚úÖ Developer reply posted successfully');
                
                // Hide reply form and clear textarea
                hideDeveloperReply(reviewId);
                
                // Show success message
                alert('Your developer reply has been posted successfully!');
                
                // Refresh reviews to show the new reply
                refreshModalReviews();
                
            } catch (error) {
                console.error('‚ùå Error posting developer reply:', error);
                alert('Error posting reply. Please try again.');
            }
        }

        // Make reply functions globally available
        window.showDeveloperReply = showDeveloperReply;
        window.hideDeveloperReply = hideDeveloperReply;
        window.submitDeveloperReply = submitDeveloperReply;
    </script>

    <!-- Profile Picture Crop Modal -->
    <div id="crop-modal" class="crop-modal" style="display: none;">
        <div class="crop-modal-content">
            <div class="crop-modal-header">
                <h3>Crop Profile Picture</h3>
                <button class="crop-modal-close" id="crop-modal-close">&times;</button>
            </div>
            <div class="crop-container">
                <div class="crop-preview-container">
                    <img id="crop-image" class="crop-image" src="" alt="Crop Preview">
                    <div class="crop-overlay">
                        <div class="crop-circle"></div>
                    </div>
                </div>
            </div>
            <div class="crop-controls">
                <div class="zoom-control">
                    <label>Zoom:</label>
                    <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1">
                </div>
                <div class="crop-actions">
                    <button id="crop-cancel" class="crop-btn crop-cancel">Cancel</button>
                    <button id="crop-confirm" class="crop-btn crop-confirm">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Load published creator submissions directly into the main games grid
    (function(){
        function escapeHtml(str=''){
            return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

    function buildSubmissionCard(doc){
            const id = doc.id;
            const title = escapeHtml(doc.title || 'Untitled');
            const desc = escapeHtml((doc.description || '').slice(0, 180));
            const cover = (typeof doc.coverImageUrl === 'string' && doc.coverImageUrl) ? doc.coverImageUrl : 'assets/icons/anonymous.png';
            const playUrl = (typeof doc.playUrl === 'string' && /^https?:\/\//i.test(doc.playUrl)) ? doc.playUrl : null;
            const tags = Array.isArray(doc.tags) ? doc.tags.slice(0,4) : [];
            const badge = (typeof doc.badge === 'string' && ['new','updated','beta'].includes(doc.badge)) ? doc.badge : null;
            const badgeLabel = badge === 'new' ? 'NEW' : (badge === 'updated' ? 'UPDATED' : (badge === 'beta' ? 'BETA' : ''));

            const card = document.createElement('div');
            card.className = 'game-card is-submission';
            card.setAttribute('data-game', id);
            if (doc.ownerId) { try { card.setAttribute('data-owner', String(doc.ownerId)); } catch {} }
            card.innerHTML = `
                <div class="card-image">
                    <img src="${cover}" alt="${title}" class="game-logo-image" loading="lazy" decoding="async">
                    <div class="card-overlay"></div>
                    ${badge ? `<div class="game-badge ${badge}">${badgeLabel}</div>` : `<div class=\"game-badge new\" style=\"display:${doc.featured ? 'block' : 'none'};\">NEW</div>`}
                    <!-- Game Card Menu Buttons (top right) for submissions -->
                    <div class="game-card-menu" data-game-menu>
                        <button class="menu-btn edit-btn" data-action="edit" title="Edit Game" style="display:none;">‚úèÔ∏è Edit</button>
                        <button class="menu-btn delete-btn" data-action="delete" title="Delete Game" style="display:none;">üóëÔ∏è Delete</button>
                        <button class="menu-btn report-btn" data-action="report" title="Report Game" style="display:none;">üö© Report</button>
                        <button class="menu-btn three-dot-btn" data-action="report" title="Report Game">‚ãÆ</button>
                    </div>
                </div>
                <div class="card-content">
                    <h3 class="card-title">${title}</h3>
                    <p class="card-description">${desc || 'No description provided.'}</p>
                    <p class="card-developer">Made by <a href="about.html"><strong>Community</strong></a>
                        <button class="review-btn" onclick="openReviewModal('${id}','${title.replace(/'/g, "&#39;")}')">‚≠ê Review</button>
                        <span class="rating-display" data-game-id="${id}"><span class="no-rating">N/A (0)</span></span>
                    </p>
                    <div class="card-tags">
                        ${tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                    ${ playUrl
                        ? `<button onclick="window.open('${playUrl.replace(/'/g, "&#39;")}', '_blank')" class="btn btn-primary card-btn">Play Now</button>`
                        : `<button class="btn btn-disabled card-btn" disabled>Play link pending</button>`
                    }
                </div>`;
            return card;
        }

        function startRealtimePublishedIntoMainGrid(){
            (async function init(){
                try{
                    if(!window.firebaseFirestore || !window.firestoreCollection || !window.firestoreWhere){
                        console.log('[games grid] Firestore not ready ‚Äì retrying...');
                        return setTimeout(startRealtimePublishedIntoMainGrid, 600);
                    }
                    const container = document.querySelector('.game-cards');
                    if(!container) return;
                    if(container.dataset.communityLoaded === '1') return; // prevent duplicate listener
                    container.dataset.communityLoaded = '1';

                    // Ensure onSnapshot is available
                    if (!window.firestoreOnSnapshot) {
                        const f = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        window.firestoreOnSnapshot = f.onSnapshot;
                        window.firestoreGetDoc = window.firestoreGetDoc || f.getDoc;
                        window.firestoreDoc = window.firestoreDoc || f.doc;
                    }

                    const submissionsRef = window.firestoreCollection(window.firebaseFirestore, 'game_submissions');
                    const q = window.firestoreQuery(
                        submissionsRef,
                        window.firestoreWhere('status','in',['published','Published'])
                    );

                    // Attach listener
                    const unsubscribe = window.firestoreOnSnapshot(q, (snapshot) => {
                        try {
                            const list = [];
                            snapshot.forEach(d => list.push({ id: d.id, ...d.data() }));
                            // Sort by updatedAt desc then createdAt desc
                            list.sort((a,b)=>{
                                const at = (a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0);
                                const bt = (b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0);
                                return bt - at;
                            });

                            // Remove previously rendered submission cards
                            container.querySelectorAll('.game-card.is-submission').forEach(el => el.remove());

                            // Rebuild
                            const frag = document.createDocumentFragment();
                            for(const d of list){
                                frag.appendChild(buildSubmissionCard(d));
                            }
                            const comingSoon = container.querySelector('.game-card.coming-soon');
                            if (comingSoon && comingSoon.parentNode === container){
                                container.insertBefore(frag, comingSoon);
                            } else {
                                container.appendChild(frag);
                            }

                            // Update menus and ratings
                            if (typeof setupGameCardMenus === 'function') {
                                try { setupGameCardMenus(); } catch {}
                                // Re-run shortly after to catch any auth state changes or slow DOM attachments
                                try { setTimeout(setupGameCardMenus, 250); } catch {}
                            }
                            setTimeout(updateAllRatingDisplays, 200);
                        } catch (err) {
                            console.error('[games grid] snapshot render failed:', err);
                        }
                    }, (error) => {
                        console.error('[games grid] realtime error:', error);
                    });

                    // Clean up on unload
                    window.addEventListener('beforeunload', () => { try { unsubscribe(); } catch {} }, { once: true });
                }catch(e){
                    console.error('[games grid] Failed to init realtime listener:', e);
                }
            })();
        }

        window.addEventListener('DOMContentLoaded', () => setTimeout(startRealtimePublishedIntoMainGrid, 800));
    })();
    </script>

    </body>
        <script>
        /* BMC widget lazy loader */
        (function(){
            const cfg = {src:'https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js',id:'glitchrealmdevs',desc:'Support me on Buy me a coffee!',msg:'Contribute to the development of GlitchRealm.',color:'#5F7FFF',pos:'Right',x:'18',y:'18'};
            function inject(){
                if(document.getElementById('bmc-widget-script')) return;
                const s=document.createElement('script');
                s.id='bmc-widget-script';
                s.src=cfg.src; s.dataset.name='BMC-Widget'; s.setAttribute('data-cfasync','false');
                s.setAttribute('data-id',cfg.id); s.setAttribute('data-description',cfg.desc); s.setAttribute('data-message',cfg.msg);
                s.setAttribute('data-color',cfg.color); s.setAttribute('data-position',cfg.pos);
                s.setAttribute('data-x_margin',cfg.x); s.setAttribute('data-y_margin',cfg.y);
                document.body.appendChild(s);
            }
            if(window.requestIdleCallback) requestIdleCallback(inject,{timeout:2500});
            else window.addEventListener('load',()=>setTimeout(inject,600));
            ['pointerdown','keydown','scroll'].forEach(evt=>window.addEventListener(evt,inject,{once:true,passive:true}));
        })();
        </script>
    </html>
