<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playtime Tracking Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #f44336;
        }
        button.secondary:hover {
            background-color: #d32f2f;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            min-height: 100px;
        }
        .login-status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .login-status.logged-in {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
        }
        .login-status.logged-out {
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
        }
    </style>
</head>
<body>
    <h1>GlitchRealm Playtime Tracking Test</h1>
    
    <div id="loginStatus" class="login-status logged-out">
        <p>Not logged in. Playtime tracking requires authentication.</p>
        <button id="loginBtn">Log In</button>
        <button id="logoutBtn">Log Out</button>
    </div>
    
    <div class="section">
        <h2>Playtime Tracker Functions</h2>
        <p>Test the playtime tracking functionality:</p>
        <button id="startTracking">Start Tracking</button>
        <button id="stopTracking">Stop Tracking</button>
        <button id="savePlaytime">Save Playtime Data</button>
        <button id="getPlaytimeData">Get Playtime Data</button>
    </div>
    
    <div class="section">
        <h2>Test Game Launcher</h2>
        <p>Launch games to test playtime tracking:</p>
        <button data-game-launch="coderunner">Launch CodeRunner</button>
        <button data-game-launch="bytesurge">Launch ByteSurge</button>
        <button data-game-launch="bytewars">Launch NeuroCore: Byte Wars</button>
    </div>
    
    <div class="section">
        <h2>Simulate Game Events</h2>
        <p>Simulate different game events:</p>
        <button id="simulateGameStart">Simulate Game Start</button>
        <button id="simulateGameEnd">Simulate Game End</button>
        <button id="simulateTabHidden">Simulate Tab Hidden</button>
        <button id="simulateTabVisible">Simulate Tab Visible</button>
    </div>
    
    <div class="section">
        <h2>Playtime Data</h2>
        <p>Current tracking status and playtime data:</p>
        <div id="playtimeResult" class="result">
            <p>No data available yet. Start tracking and perform actions to see results.</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Add Test Data</h2>
        <p>Add test playtime data to your account:</p>
        <label for="gameId">Game ID:</label>
        <select id="gameId">
            <option value="coderunner">CodeRunner</option>
            <option value="bytesurge">ByteSurge</option>
            <option value="bytewars">NeuroCore: Byte Wars</option>
        </select>
        <label for="seconds">Seconds to add:</label>
        <input type="number" id="seconds" value="300" min="1" max="3600">
        <button id="addTestData">Add Test Data</button>
        <button id="resetData" class="secondary">Reset All Playtime Data</button>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Game Launcher and Integration -->
    <script src="game-launcher.js"></script>
    <script src="portal-playtime-integration.js"></script>
    
    <!-- Import PlaytimeTracker -->
    <script type="module">
        import { PlaytimeTracker } from './playtime-tracker.js';
        
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCo5hr7ULHLL_0UAAst74g8ePZxkB7OHFQ",
          authDomain: "shared-sign-in.firebaseapp.com",
          databaseURL: "https://shared-sign-in-default-rtdb.firebaseio.com/",
          projectId: "shared-sign-in",
          storageBucket: "shared-sign-in.firebasestorage.app",
          messagingSenderId: "332039027753",
          appId: "1:332039027753:web:aa7c6877d543bb90363038",
          measurementId: "G-KK5XVVLMVN"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Make Firebase auth available to the game launcher
        window.firebaseAuth = firebase.auth();
        
        // Elements
        const loginStatusEl = document.getElementById('loginStatus');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const startTrackingBtn = document.getElementById('startTracking');
        const stopTrackingBtn = document.getElementById('stopTracking');
        const savePlaytimeBtn = document.getElementById('savePlaytime');
        const getPlaytimeDataBtn = document.getElementById('getPlaytimeData');
        const simulateGameStartBtn = document.getElementById('simulateGameStart');
        const simulateGameEndBtn = document.getElementById('simulateGameEnd');
        const simulateTabHiddenBtn = document.getElementById('simulateTabHidden');
        const simulateTabVisibleBtn = document.getElementById('simulateTabVisible');
        const playtimeResultEl = document.getElementById('playtimeResult');
        const gameIdSelect = document.getElementById('gameId');
        const secondsInput = document.getElementById('seconds');
        const addTestDataBtn = document.getElementById('addTestData');
        const resetDataBtn = document.getElementById('resetData');
        
        // Create the playtime tracker
        let tracker = null;
        
        // Update UI based on auth state
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                loginStatusEl.className = 'login-status logged-in';
                loginStatusEl.innerHTML = `
                    <p>Logged in as: ${user.email || user.uid}</p>
                    <button id="logoutBtn">Log Out</button>
                `;
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
                // Initialize the tracker
                initTracker();
            } else {
                loginStatusEl.className = 'login-status logged-out';
                loginStatusEl.innerHTML = `
                    <p>Not logged in. Playtime tracking requires authentication.</p>
                    <button id="loginBtn">Log In</button>
                `;
                document.getElementById('loginBtn').addEventListener('click', login);
                
                // Clear the tracker
                tracker = null;
                updatePlaytimeDisplay();
            }
        });
        
        // Initialize the tracker
        async function initTracker() {
            tracker = new PlaytimeTracker();
            await tracker.init('test', 'Playtime Test', true);
            updatePlaytimeDisplay();
        }
        
        // Login
        function login() {
            firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())
                .catch(error => {
                    console.error('Login error:', error);
                    alert(`Login failed: ${error.message}`);
                });
        }
        
        // Logout
        function logout() {
            firebase.auth().signOut()
                .catch(error => {
                    console.error('Logout error:', error);
                    alert(`Logout failed: ${error.message}`);
                });
        }
        
        // Update the playtime display
        function updatePlaytimeDisplay() {
            if (!tracker) {
                playtimeResultEl.innerHTML = '<p>No tracker available. Please log in first.</p>';
                return;
            }
            
            const status = tracker.isTracking ? 'Running' : 'Stopped';
            const startTime = tracker.startTime ? new Date(tracker.startTime).toLocaleTimeString() : 'N/A';
            const hours = tracker.sessionTime || 0;
            const minutes = Math.floor(hours * 60);
            const seconds = Math.floor(hours * 3600);
            
            playtimeResultEl.innerHTML = `
                <p><strong>Tracking Status:</strong> ${status}</p>
                <p><strong>Start Time:</strong> ${startTime}</p>
                <p><strong>Current Session Playtime:</strong> ${formatPlaytime(seconds)}</p>
                <p><strong>Game ID:</strong> ${tracker.gameId}</p>
                <p><strong>Game Name:</strong> ${tracker.gameName}</p>
            `;
        }
        
        // Format playtime in a human-readable format
        function formatPlaytime(seconds) {
            if (seconds < 60) {
                return `${seconds} second${seconds !== 1 ? 's' : ''}`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ${remainingSeconds} second${remainingSeconds !== 1 ? 's' : ''}`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const remainingMinutes = Math.floor((seconds % 3600) / 60);
                return `${hours} hour${hours !== 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
            }
        }
        
        // Add test playtime data
        async function addTestPlaytimeData() {
            if (!tracker || !firebase.auth().currentUser) {
                alert('You must be logged in to add test data.');
                return;
            }
            
            try {
                const gameId = gameIdSelect.value;
                const seconds = parseInt(secondsInput.value);
                
                if (isNaN(seconds) || seconds <= 0) {
                    alert('Please enter a valid number of seconds.');
                    return;
                }
                
                const userId = firebase.auth().currentUser.uid;
                const db = firebase.firestore();
                const userRef = db.collection('users').doc(userId);
                
                // Game names mapping
                const gameNames = {
                    'coderunner': 'CodeRunner',
                    'bytesurge': 'ByteSurge',
                    'bytewars': 'NeuroCore: Byte Wars'
                };
                
                // Get the user document
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    // Update existing user document
                    const userData = userDoc.data();
                    const playtime = userData.playtime || { total: 0, games: {} };
                    const gameData = playtime.games[gameId] || { name: gameNames[gameId], seconds: 0 };
                    
                    // Update the game data
                    const updatedGameData = {
                        name: gameNames[gameId],
                        seconds: gameData.seconds + seconds,
                        lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Calculate the new total playtime
                    const newTotal = (playtime.total || 0) + seconds;
                    
                    // Update the user document
                    await userRef.update({
                        [`playtime.total`]: newTotal,
                        [`playtime.games.${gameId}`]: updatedGameData
                    });
                } else {
                    // Create user document if it doesn't exist
                    await userRef.set({
                        email: firebase.auth().currentUser.email || '',
                        displayName: firebase.auth().currentUser.displayName || '',
                        playtime: {
                            total: seconds,
                            games: {
                                [gameId]: {
                                    name: gameNames[gameId],
                                    seconds: seconds,
                                    lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            }
                        }
                    });
                }
                
                alert(`Added ${seconds} seconds of playtime to ${gameNames[gameId]}.`);
                
                // Refresh the playtime data display by fetching from Firestore
                try {
                    const userId = firebase.auth().currentUser.uid;
                    const db = firebase.firestore();
                    const userDoc = await db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.playtime) {
                            displayPlaytimeData(userData.playtime);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching updated playtime data:', error);
                }
            } catch (error) {
                console.error('Error adding test playtime data:', error);
                alert(`Error adding test data: ${error.message}`);
            }
        }
        
        // Reset all playtime data
        async function resetPlaytimeData() {
            if (!firebase.auth().currentUser) {
                alert('You must be logged in to reset data.');
                return;
            }
            
            if (!confirm('Are you sure you want to reset ALL playtime data? This cannot be undone!')) {
                return;
            }
            
            try {
                const userId = firebase.auth().currentUser.uid;
                const db = firebase.firestore();
                const userRef = db.collection('users').doc(userId);
                
                // Reset playtime data
                await userRef.update({
                    'playtime.total': 0,
                    'playtime.games': {}
                });
                
                alert('All playtime data has been reset.');
                
                // Refresh the playtime data display
                try {
                    const userId = firebase.auth().currentUser.uid;
                    const db = firebase.firestore();
                    const userDoc = await db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.playtime) {
                            displayPlaytimeData(userData.playtime);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching updated playtime data:', error);
                }
            } catch (error) {
                console.error('Error resetting playtime data:', error);
                alert(`Error resetting data: ${error.message}`);
            }
        }
        
        // Display playtime data from Firestore
        function displayPlaytimeData(data) {
            if (!data) {
                playtimeResultEl.innerHTML += '<p><strong>Firestore Data:</strong> No data available</p>';
                return;
            }
            
            let html = '<p><strong>Firestore Playtime Data:</strong></p>';
            
            // Check if we're using the new data structure (total in hours) or the old one (total in seconds)
            let totalSeconds = 0;
            if (typeof data.total === 'number') {
                // If the total is a small number, it's likely hours
                if (data.total < 1000) {
                    totalSeconds = Math.floor(data.total * 3600); // Convert hours to seconds
                } else {
                    totalSeconds = data.total; // It's already in seconds
                }
            }
            
            html += `<p>Total Playtime: ${formatPlaytime(totalSeconds)}</p>`;
            html += '<p><strong>Games:</strong></p><ul>';
            
            for (const [gameId, game] of Object.entries(data.games || {})) {
                let gameSeconds = 0;
                
                // Handle both data structures
                if (typeof game.seconds === 'number') {
                    gameSeconds = game.seconds;
                } else if (typeof game.hours === 'number') {
                    gameSeconds = Math.floor(game.hours * 3600);
                }
                
                const lastPlayed = game.lastPlayed ? 
                    new Date(game.lastPlayed.seconds * 1000).toLocaleString() : 'Unknown';
                
                html += `<li><strong>${game.name}</strong>: ${formatPlaytime(gameSeconds)} (Last played: ${lastPlayed})</li>`;
            }
            
            html += '</ul>';
            playtimeResultEl.innerHTML += html;
        }
        
        // Event listeners
        startTrackingBtn.addEventListener('click', () => {
            if (tracker) {
                tracker.startTracking();
                updatePlaytimeDisplay();
            } else {
                alert('Please log in first.');
            }
        });
        
        stopTrackingBtn.addEventListener('click', () => {
            if (tracker) {
                tracker.stopTracking(false);
                updatePlaytimeDisplay();
            }
        });
        
        savePlaytimeBtn.addEventListener('click', async () => {
            if (tracker) {
                await tracker.savePlaytimeData();
                updatePlaytimeDisplay();
                alert('Playtime data saved!');
            }
        });
        
        getPlaytimeDataBtn.addEventListener('click', async () => {
            if (!tracker || !firebase.auth().currentUser) {
                alert('You must be logged in to view playtime data.');
                return;
            }
            
            try {
                const userId = firebase.auth().currentUser.uid;
                const db = firebase.firestore();
                const userDoc = await db.collection('users').doc(userId).get();
                
                updatePlaytimeDisplay();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.playtime) {
                        displayPlaytimeData(userData.playtime);
                    } else {
                        playtimeResultEl.innerHTML += '<p><strong>Firestore Data:</strong> No playtime data found</p>';
                    }
                } else {
                    playtimeResultEl.innerHTML += '<p><strong>Firestore Data:</strong> User document not found</p>';
                }
            } catch (error) {
                console.error('Error fetching playtime data:', error);
                playtimeResultEl.innerHTML += `<p><strong>Error:</strong> ${error.message}</p>`;
            }
        });
        
        simulateGameStartBtn.addEventListener('click', () => {
            window.dispatchEvent(new Event('gameStarted'));
            updatePlaytimeDisplay();
        });
        
        simulateGameEndBtn.addEventListener('click', () => {
            window.dispatchEvent(new Event('gameEnded'));
            updatePlaytimeDisplay();
        });
        
        simulateTabHiddenBtn.addEventListener('click', () => {
            document.dispatchEvent(new Event('visibilitychange'));
            Object.defineProperty(document, 'hidden', { value: true, writable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            setTimeout(() => {
                Object.defineProperty(document, 'hidden', { value: false, writable: true });
                updatePlaytimeDisplay();
            }, 1000);
        });
        
        simulateTabVisibleBtn.addEventListener('click', () => {
            Object.defineProperty(document, 'hidden', { value: false, writable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            updatePlaytimeDisplay();
        });
        
        addTestDataBtn.addEventListener('click', addTestPlaytimeData);
        resetDataBtn.addEventListener('click', resetPlaytimeData);
        
        // Initial setup
        updatePlaytimeDisplay();
    </script>
</body>
</html>
