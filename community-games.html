<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Games - GlitchRealm</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="styles.css">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet"></noscript>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <style>
    .cg-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:16px; }
    .cg-card { border:1px solid var(--gray-700); border-radius:12px; padding:14px; background: rgba(255,255,255,0.02); }
    .cg-title { font-weight:800; margin:0 0 6px 0; }
    .cg-desc { opacity:.9; margin:0 0 8px 0; max-height: 6em; overflow: hidden; }
    .cg-meta { opacity:.85; font-size:.92rem; display:flex; align-items:center; gap:6px; }
  /* uses global .verified-badge styles from styles.css */
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    const firebaseConfig = {
      apiKey: "AIzaSyCo5hr7ULHLL_0UAAst74g8ePZxkB7OHFQ",
      authDomain: "shared-sign-in.firebaseapp.com",
      projectId: "shared-sign-in",
  storageBucket: "shared-sign-in.appspot.com",
      messagingSenderId: "332039027753",
      appId: "1:332039027753:web:aa7c6877d543bb90363038",
      measurementId: "G-KK5XVVLMVN"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.firebaseAuth = auth;
    window.firebaseFirestore = db;
    async function isVerified(uid){
      try { const s = await getDoc(doc(db,'verified_users',uid)); return s.exists() && s.data()?.verified === true; } catch { return false; }
    }
    async function loadList(){
      const host = document.getElementById('cg-list');
      host.innerHTML = '<div style="opacity:.8">Loading…</div>';
      try {
        // Simple query to avoid composite indexes locally; filter client-side
        const qy = query(collection(db,'community_games'), orderBy('createdAt','desc'));
        const snap = await getDocs(qy);
        if (snap.empty) { host.innerHTML = '<div style="opacity:.8">No community games yet.</div>'; return; }
        const rows = [];
        for (const d of snap.docs) {
          const g = d.data();
          if (!['public','unlisted'].includes(g.visibility||'public')) continue;
          const ok = await isVerified(g.ownerId||'');
          const ownerName = (g.ownerId||'').slice(0,6) + '…';
          rows.push(`<div class="cg-card">
            <div class="cg-title">${escapeHtml(g.title||'Untitled')}</div>
            <p class="cg-desc">${escapeHtml((g.description||'').slice(0,240))}${(g.description||'').length>240?'…':''}</p>
            <div class="cg-meta">by <span data-uid="${escapeHtml(g.ownerId||'')}">${escapeHtml(ownerName)}</span>${ok?'<span class="verified-badge" title="Verified" aria-label="Verified"><svg viewBox=\"0 0 24 24\"><path d=\"M12 2l2.9 2.1 3.5-.3 1.1 3.3 3 1.8-1.2 3.3 1.2 3.3-3 1.8-1.1 3.3-3.5-.3L12 22l-2.9-2.1-3.5.3-1.1-3.3-3-1.8L2.7 12 1.5 8.7l3-1.8 1.1-3.3 3.5.3L12 2zm-1.2 13.6l6-6-1.4-1.4-4.6 4.6-2.2-2.2-1.4 1.4 3.6 3.6z\"/></svg></span>':''} • <code>${escapeHtml(g.slug||d.id)}</code></div>
          </div>`);
        }
        host.innerHTML = rows.join('');
      } catch(e) { host.innerHTML = '<div style="opacity:.8">Failed to load.</div>'; }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    window.addEventListener('DOMContentLoaded', loadList);
  </script>
</head>
<body>
  <div class="background-animation"></div>
  <div id="header-placeholder"></div>
  <main class="main">
    <section class="games-hero">
      <div class="container">
        <h1 class="page-title"><span class="glitch" data-text="Community Games">Community Games</span></h1>
        <p class="page-subtitle">Player-made games from verified creators</p>
      </div>
    </section>
    <section class="contact-content">
      <div class="container">
        <div id="cg-list" class="cg-grid"></div>
      </div>
    </section>
  </main>
  <div id="footer-placeholder"></div>
  <script src="script.js" defer></script>
</body>
<script>(function(){const c={src:'https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js',id:'glitchrealmdevs',desc:'Support me on Buy me a coffee!',msg:'Contribute to the development of GlitchRealm.',color:'#5F7FFF',pos:'Right',x:'18',y:'18'};function i(){if(document.getElementById('bmc-widget-script'))return;const s=document.createElement('script');s.id='bmc-widget-script';s.src=c.src;s.dataset.name='BMC-Widget';s.setAttribute('data-cfasync','false');s.setAttribute('data-id',c.id);s.setAttribute('data-description',c.desc);s.setAttribute('data-message',c.msg);s.setAttribute('data-color',c.color);s.setAttribute('data-position',c.pos);s.setAttribute('data-x_margin',c.x);s.setAttribute('data-y_margin',c.y);document.body.appendChild(s);}if(window.requestIdleCallback)requestIdleCallback(i,{timeout:2500});else window.addEventListener('load',()=>setTimeout(i,600));['pointerdown','keydown','scroll'].forEach(e=>window.addEventListener(e,i,{once:true,passive:true}));})();</script>
</html>