<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game Detail - GlitchRealm</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <!-- minimal header include -->
        <a href="index.html">Home</a> | <a href="games.html">Games</a>
    </header>

    <main class="container">
        <section id="game-info">
            <h1 id="game-title">Loading...</h1>
            <div id="game-description">Loading description...</div>
            <div id="game-screenshots" style="display:flex;gap:16px;flex-wrap:wrap;"></div>
            <div id="play-buttons"></div>
        </section>

        <section id="reviews-section">
            <h2>Reviews <span id="reviews-count">(0)</span></h2>
            <div id="reviews-list">Loading reviews...</div>

            <div id="review-form">
                <h3>Leave a review</h3>
                <div class="star-inputs">
                    <button class="star" data-rating="1">1</button>
                    <button class="star" data-rating="2">2</button>
                    <button class="star" data-rating="3">3</button>
                    <button class="star" data-rating="4">4</button>
                    <button class="star" data-rating="5">5</button>
                </div>
                <textarea id="reviewComment" maxlength="500" placeholder="Write your review..." rows="4"></textarea>
                <div id="charCounter">0/500</div>
                <button id="submitReviewBtn">Submit Review</button>
                <div id="reviewMessage"></div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, limit, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCo5hr7ULHLL_0UAAst74g8ePZxkB7OHFQ",
            authDomain: "shared-sign-in.firebaseapp.com",
            projectId: "shared-sign-in",
            storageBucket: "shared-sign-in.appspot.com",
            messagingSenderId: "332039027753",
            appId: "1:332039027753:web:aa7c6877d543bb90363038",
            measurementId: "G-KK5XVVLMVN"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseFirestore = db;
        window.firestoreCollection = collection;
        window.firestoreGetDocs = getDocs;
        window.firestoreQuery = query;
        window.firestoreWhere = where;
        window.firestoreOrderBy = orderBy;
        window.firestoreLimit = limit;
        window.firestoreAddDoc = addDoc;

        // Utilities
        function qs(key) {
            const params = new URLSearchParams(window.location.search);
            return params.get(key);
        }

        const gameId = qs('game') || '';
        const gameTitleEl = document.getElementById('game-title');
        const gameGuideEl = document.getElementById('game-guide');
        const reviewsListEl = document.getElementById('reviews-list');
        const reviewsCountEl = document.getElementById('reviews-count');

        // Minimal placeholder guide loader - in future this can fetch a CMS/doc
        async function loadGameInfo(id) {
            const descEl = document.getElementById('game-description');
            const shotsEl = document.getElementById('game-screenshots');
            descEl.textContent = 'Loading description...';
            shotsEl.innerHTML = '';
            try {
                const mod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const docRef = mod.doc(window.firebaseFirestore, 'game_submissions', id);
                const snap = await mod.getDoc(docRef);
                if (snap && snap.exists()) {
                    const data = snap.data();
                    gameTitleEl.textContent = data.title || id;
                    descEl.innerHTML = `<p>${escapeHtml(data.description || 'No description available.').replace(/\n/g,'<br>')}</p>`;
                    // Screenshots: expect array of URLs in data.screenshots or single coverImageUrl
                    let screenshots = [];
                    if (Array.isArray(data.screenshots) && data.screenshots.length) {
                        screenshots = data.screenshots;
                    } else if (typeof data.coverImageUrl === 'string' && data.coverImageUrl) {
                        screenshots = [data.coverImageUrl];
                    }
                    if (screenshots.length) {
                        shotsEl.innerHTML = screenshots.map(url => `<img src="${escapeHtml(url)}" alt="Screenshot" style="max-width:320px;max-height:180px;border-radius:8px;box-shadow:0 2px 12px #0008;" loading="lazy">`).join('');
                    } else {
                        shotsEl.innerHTML = '<span style="color:#888">No screenshots available.</span>';
                    }
                    if (data.playUrl) {
                        document.getElementById('play-buttons').innerHTML = `<a class=\"btn btn-primary\" href=\"${data.playUrl}\" target=\"_blank\">Play Now</a>`;
                    }
                    return;
                }
            } catch (e) {
                console.warn('Failed to load submission info', e);
            }
            // Fallback
            gameTitleEl.textContent = id || 'Unknown Game';
            descEl.textContent = 'No description available for this game.';
            shotsEl.innerHTML = '<span style="color:#888">No screenshots available.</span>';
        }

        // Reuse display helpers (simple versions)
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function generateStarsDisplay(rating) { let s = '⭐'.repeat(Math.floor(rating)) + '☆'.repeat(5-Math.floor(rating)); return s; }

        async function loadReviews(id) {
            try {
                reviewsListEl.innerHTML = '<div class="reviews-loading">Loading reviews...</div>';
                const reviewsRef = window.firestoreCollection(window.firebaseFirestore, 'reviews');
                const q = window.firestoreQuery(reviewsRef, window.firestoreWhere('gameId','==', id), window.firestoreWhere('moderationStatus','==','approved'), window.firestoreOrderBy('timestamp','desc'), window.firestoreLimit(20));
                const snaps = await window.firestoreGetDocs(q);
                const reviews = [];
                snaps.forEach(d => reviews.push({id:d.id, ...d.data()}));
                reviewsListEl.innerHTML = '';
                if (reviews.length === 0) {
                    reviewsListEl.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to leave a review!</div>';
                    reviewsCountEl.textContent = '(0)';
                    return;
                }
                reviewsCountEl.textContent = `(${reviews.length})`;
                for (const r of reviews) {
                    const div = document.createElement('div');
                    div.className = 'review-item';
                    div.innerHTML = `
                        <div class="review-header">
                            <div class="review-avatar-wrap"><img class="review-avatar" src="${escapeHtml(r.authorPhotoUrl||'assets/icons/anonymous.png')}" /></div>
                            <div class="review-body">
                                <div class="review-meta-line"> <strong>${escapeHtml(r.userDisplayName||'Anonymous')}</strong> <span class="review-rating">${generateStarsDisplay(r.rating)} <small>${r.rating}/5</small></span></div>
                                <p class="review-comment">${escapeHtml(r.comment||'')}</p>
                            </div>
                        </div>
                    `;
                    reviewsListEl.appendChild(div);
                }
            } catch (e) {
                console.error('Failed to load reviews', e);
                reviewsListEl.innerHTML = '<div class="reviews-empty">Error loading reviews.</div>';
            }
        }

        // Basic review submit using same validations as site (simplified content check)
        let currentRating = 0;
        document.querySelectorAll('.star-inputs .star').forEach(btn => {
            btn.addEventListener('click', () => {
                currentRating = parseInt(btn.dataset.rating || '0', 10);
                document.querySelectorAll('.star-inputs .star').forEach(s => s.classList.toggle('active', s===btn));
            });
        });

        document.getElementById('reviewComment').addEventListener('input', () => {
            const len = document.getElementById('reviewComment').value.length;
            document.getElementById('charCounter').textContent = `${len}/500`;
        });

        document.getElementById('submitReviewBtn').addEventListener('click', async () => {
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                alert('Please sign in to submit a review.');
                window.location.href = 'signin.html';
                return;
            }
            if (currentRating === 0) { alert('Please pick a rating.'); return; }
            const comment = document.getElementById('reviewComment').value.trim();
            const user = window.firebaseAuth.currentUser;
            const review = {
                gameId: gameId,
                gameName: (gameTitleEl.textContent||'').substring(0,100),
                rating: Math.min(5, Math.max(1, Math.round(currentRating))),
                comment: comment.substring(0,500),
                moderationStatus: 'pending',
                timestamp: new Date().toISOString(),
                userId: user.uid,
                userDisplayName: user.displayName || (user.email ? user.email.split('@')[0] : 'Anonymous'),
                authorPhotoUrl: user.photoURL || 'assets/icons/anonymous.png'
            };
            try {
                await window.firestoreAddDoc(window.firestoreCollection(window.firebaseFirestore, 'reviews'), review);
                alert('Review submitted. It may require moderation.');
                document.getElementById('reviewComment').value = '';
                currentRating = 0;
                loadReviews(gameId);
            } catch (e) {
                console.error('Submit review failed', e);
                alert('Failed to submit review: ' + (e.message || e));
            }
        });

        // Init
        (async function init(){
            if (!gameId) {
                gameTitleEl.textContent = 'No game selected';
                gameGuideEl.textContent = 'Please open this page via the Games page.';
                return;
            }
            await loadGameInfo(gameId);
            await loadReviews(gameId);
        })();
    </script>
</body>
</html>
